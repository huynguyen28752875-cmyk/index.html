<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zombie Fix - No Mirror</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        canvas { display: block; background: #111; }
        .ui-setup { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid #333; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        .btn-ctrl { position: absolute; border-radius: 50%; color: white; font-weight: bold; display: none; z-index: 60; background: #ef4444; border: 4px solid #b91c1c; width: 70px; height: 70px; }
        #btn-shoot { bottom: 40px; right: 40px; }
    </style>
</head>
<body>

    <div id="setup-screen" class="ui-setup">
        <h2 class="text-3xl font-black text-red-600 mb-6 italic">ZOMBIE EVOLUTION FIX</h2>
        <input type="text" id="name-in" class="p-4 rounded-xl w-64 text-black font-bold mb-4 outline-none" placeholder="Tên bạn">
        <input type="text" id="room-in" class="p-4 rounded-xl w-64 text-black font-bold mb-6 outline-none" placeholder="Mã phòng">
        <button onclick="startConnection()" class="bg-blue-600 px-10 py-4 rounded-2xl font-black text-lg active:scale-95 transition-all">KÍCH HOẠT & VÀO GAME</button>
        <p id="status" class="mt-4 text-gray-400 text-sm italic text-center px-4"></p>
    </div>

    <div id="game-ui" class="hidden absolute top-0 w-full p-4 flex justify-between pointer-events-none text-white z-50">
        <div class="bg-black/60 p-2 rounded border-l-4 border-blue-500">
            <p id="my-name-display" class="font-bold text-xs"></p>
            <p class="text-[10px]">HP: <span id="my-hp">100</span> | LV: <span id="my-lv">1</span></p>
        </div>
        <div class="bg-black/60 p-2 rounded border-r-4 border-red-500 text-right">
            <p id="peer-name-display" class="font-bold text-xs text-red-400">CHỜ ĐỒNG ĐỘI...</p>
            <p class="text-[10px]">HP: <span id="peer-hp">100</span> | SCORE: <span id="peer-score">0</span></p>
        </div>
    </div>

    <div id="joystick"><div id="stick"></div></div>
    <button id="btn-shoot" class="btn-ctrl">BẮN</button>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let peer, conn, isHost = false;

        let me = { x: 100, y: 100, hp: 100, lv: 1, score: 0, bullets: [], isDead: false };
        let enemy = { x: -500, y: -500, hp: 100, score: 0, isDead: false };
        let zombies = [];
        let keys = {};

        if ('ontouchstart' in window) {
            document.getElementById('joystick').style.display = 'block';
            document.getElementById('btn-shoot').style.display = 'block';
        }

        function startConnection() {
            const name = document.getElementById('name-in').value.trim();
            const room = document.getElementById('room-in').value.trim();
            if(!name || !room) return alert("Nhập đủ thông tin!");

            const fullRoomID = 'zom-fix-' + room.toLowerCase();
            document.getElementById('my-name-display').innerText = name;
            document.getElementById('status').innerText = "Đang kết nối PeerJS...";

            peer = new Peer(fullRoomID);

            peer.on('open', (id) => {
                isHost = true;
                document.getElementById('status').innerText = "PHÒNG ĐÃ MỞ: Đang chờ bạn mình...";
            });

            peer.on('connection', (c) => {
                conn = c;
                initGame();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    peer = new Peer(); // Làm khách
                    setTimeout(() => {
                        conn = peer.connect(fullRoomID);
                        initGame();
                    }, 500);
                }
            });
        }

        function initGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy = data.player;
                    document.getElementById('peer-name-display').innerText = data.name;
                    if(!isHost) zombies = data.zombies; // Guest lấy zombie từ Host
                }
            });
            requestAnimationFrame(gameLoop);
        }

        // Chặn phím không cho cuộn trang
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
            if(e.code === 'Space') shoot();
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function shoot() {
            if(!me.isDead) me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 10 });
        }

        function gameLoop() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Di chuyển
            if(!me.isDead) {
                if(keys['KeyW'] || keys['ArrowUp']) me.y -= 5;
                if(keys['KeyS'] || keys['ArrowDown']) me.y += 5;
                if(keys['KeyA'] || keys['ArrowLeft']) me.x -= 5;
                if(keys['KeyD'] || keys['ArrowRight']) me.x += 5;
                // Joystick di chuyển (nếu có)
                me.x += joyX; me.y += joyY;
            }

            // Host sinh Zombie
            if(isHost) {
                if(zombies.length < 5 && Math.random() < 0.02) {
                    zombies.push({ id: Date.now(), x: Math.random()*canvas.width, y: -20, hp: 50 });
                }
                zombies.forEach(z => {
                    let target = me.isDead ? enemy : me;
                    let d = Math.sqrt((target.x - z.x)**2 + (target.y - z.y)**2);
                    z.x += (target.x - z.x)/d * 1.5;
                    z.y += (target.y - z.y)/d * 1.5;
                });
            }

            // Va chạm đạn
            me.bullets.forEach((b, bi) => {
                b.x += b.vx;
                zombies.forEach((z, zi) => {
                    let d = Math.sqrt((b.x - z.x)**2 + (b.y - z.y)**2);
                    if(d < 30) {
                        z.hp -= 20;
                        me.bullets.splice(bi, 1);
                        if(z.hp <= 0) {
                            zombies.splice(zi, 1);
                            me.score += 100;
                            if(me.score % 300 === 0) me.lv++;
                        }
                    }
                });
            });

            // Gửi dữ liệu cho bạn
            if(conn && conn.open) {
                conn.send({
                    type: 'sync',
                    name: document.getElementById('name-in').value,
                    player: { x: me.x, y: me.y, hp: me.hp, score: me.score, isDead: me.isDead },
                    zombies: zombies,
                    isHost: isHost
                });
            }

            render();
            requestAnimationFrame(gameLoop);
        }

        function render() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            
            // Vẽ mình
            ctx.fillStyle = "#3b82f6";
            if(!me.isDead) ctx.fillRect(me.x, me.y, 40, 40);
            
            // Vẽ bạn
            ctx.fillStyle = "#ef4444";
            if(!enemy.isDead) ctx.fillRect(enemy.x, enemy.y, 40, 40);

            // Vẽ Zombie
            ctx.fillStyle = "#22c55e";
            zombies.forEach(z => {
                ctx.beginPath(); ctx.arc(z.x+20, z.y+20, 15, 0, 7); ctx.fill();
            });

            // Vẽ đạn
            ctx.fillStyle = "yellow";
            me.bullets.forEach(b => ctx.fillRect(b.x, b.y, 10, 4));

            // Cập nhật UI
            document.getElementById('my-hp').innerText = Math.floor(me.hp);
            document.getElementById('my-lv').innerText = me.lv;
            document.getElementById('peer-hp').innerText = Math.floor(enemy.hp);
            document.getElementById('peer-score').innerText = enemy.score;
        }

        // Joystick Logic
        let joyX = 0, joyY = 0;
        const joy = document.getElementById('joystick'), st = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            let d = Math.sqrt(dx*dx + dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            st.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx/8; joyY = dy/8;
        });
        joy.addEventListener('touchend', () => { joyX = 0; joyY = 0; st.style.transform = 'none'; });
        document.getElementById('btn-shoot').onclick = shoot;
    </script>
</body>
</html>
