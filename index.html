<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Street Fighters VN: Grand Finale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; touch-action: none; }
        canvas { display: block; filter: saturate(1.2) contrast(1.1); }
        #lobby { position: absolute; inset: 0; background: linear-gradient(135deg, #0f172a, #1e1b4b); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .char-card { border: 2px solid #334155; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; transition: 0.3s; width: 150px; text-align: center; cursor: pointer; }
        .char-card:hover { border-color: #fbbf24; transform: translateY(-5px); box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
        .p1-sel { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.2); }
        .p2-sel { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.2); }
        .locked { opacity: 0.3; pointer-events: none; }
        
        #game-ui { position: absolute; top: 30px; width: 100%; display: none; justify-content: space-around; z-index: 10; padding: 0 5%; }
        .hp-outer { width: 100%; height: 25px; background: #1e293b; border: 2px solid #fff; border-radius: 5px; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #991b1b); width: 100%; transition: 0.1s; }
        .mana-outer { width: 80%; height: 10px; background: #0f172a; border: 1px solid #0ea5e9; margin-top: 5px; border-radius: 3px; }
        .mana-fill { height: 100%; background: #38bdf8; width: 0%; transition: 0.2s; }

        #mobile-ctrl { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; z-index: 50; }
        .btn-set { display: flex; gap: 15px; }
        .m-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 id="turn-txt" class="text-5xl font-black italic text-yellow-400 mb-10 tracking-tighter">SELECT YOUR LEGEND</h1>
        <div class="char-grid" id="grid"></div>
    </div>

    <div id="game-ui">
        <div class="w-1/3">
            <div class="hp-outer"><div id="p1-hp" class="hp-fill"></div></div>
            <div class="mana-outer"><div id="p1-mana" class="mana-fill"></div></div>
            <div id="p1-n" class="text-sm mt-1 font-bold italic text-blue-400">P1</div>
        </div>
        <div class="w-1/3 text-right flex flex-col items-end">
            <div class="hp-outer"><div id="p2-hp" class="hp-fill" style="float:right"></div></div>
            <div class="mana-outer"><div id="p2-mana" class="mana-fill" style="float:right"></div></div>
            <div id="p2-n" class="text-sm mt-1 font-bold italic text-red-500">P2</div>
        </div>
    </div>

    <div id="mobile-ctrl">
        <div class="btn-set">
            <div class="m-btn" onpointerdown="keys.KeyA=true" onpointerup="keys.KeyA=false">←</div>
            <div class="m-btn" onpointerdown="keys.KeyW=true" onpointerup="keys.KeyW=false">↑</div>
            <div class="m-btn" onpointerdown="keys.KeyD=true" onpointerup="keys.KeyD=false">→</div>
        </div>
        <div class="btn-set">
            <div class="m-btn bg-blue-500/30" onpointerdown="p1.attack('Punch')">P</div>
            <div class="m-btn bg-red-500/30" onpointerdown="p1.attack('Kick')">K</div>
            <div class="m-btn bg-yellow-500/30" onpointerdown="p1.attack('Ulti')">U</div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Âm thanh
        function snd(f, t, d, v=0.1) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d);
        }

        const chars = [
            { id: 'DanChoi', name: 'DÂN CHƠI', color: '#3b82f6', s: 'Mưa Lửa' },
            { id: 'HiepSi', name: 'HIỆP SĨ', color: '#ef4444', s: 'Mưa Tên' },
            { id: 'BO', name: 'BẬC THẦY BO', color: '#a855f7', s: 'Đệ Tử' },
            { id: 'Bin', name: 'BIN', color: '#10b981', s: 'Ném Gạch' },
            { id: 'Son', name: 'SƠN', color: '#f97316', s: 'Tốc Biến' }
        ];

        let p1Char, p2Char, p1, p2, isRunning = false, keys = {}, projectiles = [], minions = [], shake = 0, flash = 0;

        // Render Lobby
        const grid = document.getElementById('grid');
        chars.forEach(c => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.id = 'btn-' + c.id;
            card.innerHTML = `<div class="font-black" style="color:${c.color}">${c.name}</div><div class="text-[10px] opacity-60">${c.s}</div>`;
            card.onclick = () => pick(c.id);
            grid.appendChild(card);
        });

        function pick(id) {
            if(!p1Char) {
                p1Char = id; document.getElementById('btn-'+id).classList.add('p1-sel', 'locked');
                document.getElementById('turn-txt').innerText = "PLAYER 2 SELECT"; snd(400, 'sine', 0.1);
            } else if(!p2Char) {
                p2Char = id; document.getElementById('btn-'+id).classList.add('p2-sel', 'locked');
                snd(600, 'sine', 0.1); setTimeout(init, 500);
            }
        }

        function init() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            if('ontouchstart' in window) document.getElementById('mobile-ctrl').style.display = 'flex';
            p1 = new Fighter(window.innerWidth*0.2, 1, p1Char);
            p2 = new Fighter(window.innerWidth*0.8, 2, p2Char);
            isRunning = true;
            // Nhạc nền giả lập
            setInterval(() => { if(isRunning) snd(60, 'sawtooth', 0.2, 0.02); }, 500);
        }

        class Fighter {
            constructor(x, id, type) {
                this.x = x; this.id = id; this.type = type;
                this.hp = 100; this.maxHp = 100; this.mana = 0;
                this.w = 70; this.h = 160; this.vy = 0; this.vx = 0;
                this.dir = id === 1 ? 1 : -1; this.isAtk = 0; this.stun = 0;
                this.color = chars.find(c => c.id === type).color;
                this.spd = (type === 'DanChoi' || type === 'Son') ? 10 : 7;
            }
            draw() {
                ctx.save();
                if(shake > 0) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);
                
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath(); ctx.ellipse(this.x+this.w/2, canvas.height-80, 40, 10, 0, 0, Math.PI*2); ctx.fill();

                // Glow effect
                ctx.shadowBlur = 15; ctx.shadowColor = this.color;
                ctx.fillStyle = this.stun > 0 ? '#475569' : this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                
                if(this.isAtk > 0) {
                    ctx.fillStyle = "rgba(255,255,255,0.7)";
                    ctx.fillRect(this.x + (this.dir > 0 ? this.w : -50), this.y + 50, 50, 30);
                    this.isAtk--;
                }
                ctx.restore();
            }
            update() {
                if(this.stun > 0) { this.stun -= 16; this.vx = 0; return; }
                this.x += this.vx; this.y += this.vy;
                if(this.y + this.h < canvas.height - 80) this.vy += 1.2;
                else { this.y = canvas.height - 80 - this.h; this.vy = 0; }
                this.mana = Math.min(100, this.mana + 0.15);
            }
            attack(t) {
                if(this.isAtk > 0 || this.stun > 0) return;
                if(t === 'Ulti' && this.mana < 100) return;
                
                if(t === 'Ulti') {
                    this.mana = 0; flash = 15; shake = 25; snd(40, 'sawtooth', 1, 0.3);
                    if(this.type === 'BO') {
                        for(let i=0; i<5; i++) minions.push({ x: this.x, y: this.y, hp: 50, owner: this.id, life: 600 });
                    } else if(this.type === 'Bin') {
                        projectiles.push({ x: this.x, y: this.y, vx: this.dir * 18, vy: -5, type: 'brick', owner: this.id });
                    } else if(this.type === 'DanChoi' || this.type === 'HiepSi') {
                        for(let i=0; i<10; i++) projectiles.push({ x: Math.random()*canvas.width, y: -100, vx: 0, vy: 12, type: this.type==='DanChoi'?'fire':'arrow', owner: this.id });
                    } else if(this.type === 'Son') {
                        let enemy = this.id === 1 ? p2 : p1;
                        this.x = enemy.x - (this.dir * 100); this.attack('Kick');
                    }
                    return;
                }
                
                this.isAtk = 12; snd(150, 'square', 0.1);
                let enemy = this.id === 1 ? p2 : p1;
                if(Math.abs(this.x - enemy.x) < 130 && Math.abs(this.y - enemy.y) < 150) {
                    enemy.hp -= t === 'Kick' ? 12 : 7; 
                    this.mana = Math.min(100, this.mana + 15);
                    shake = 10; snd(100, 'square', 0.15, 0.2); // Crowd gasp
                }
            }
        }

        window.onkeydown = e => { 
            keys[e.code] = true; 
            if(e.code === 'KeyF') p1.attack('Punch'); if(e.code === 'KeyG') p1.attack('Kick'); if(e.code === 'KeyH') p1.attack('Ulti');
            if(e.code === 'KeyK') p2.attack('Punch'); if(e.code === 'KeyL') p2.attack('Kick'); if(e.code === 'KeyJ') p2.attack('Ulti');
        };
        window.onkeyup = e => keys[e.code] = false;

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!isRunning) return requestAnimationFrame(loop);
            
            // Render Background & Flash
            ctx.fillStyle = flash > 0 ? '#fff' : '#020617'; ctx.fillRect(0,0,canvas.width, canvas.height);
            if(flash > 0) flash--;

            // Sàn đấu kịch tính
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0, canvas.height-80, canvas.width, 80);
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 4;
            for(let i=0; i<canvas.width; i+=100) { ctx.beginPath(); ctx.moveTo(i, canvas.height-80); ctx.lineTo(i-50, canvas.height); ctx.stroke(); }

            [p1, p2].forEach(p => {
                if(p.stun <= 0) {
                    p.vx = 0;
                    if(p.id === 1) {
                        if(keys.KeyA) { p.vx = -p.spd; p.dir = -1; } if(keys.KeyD) { p.vx = p.spd; p.dir = 1; }
                        if(keys.KeyW && p.vy === 0) p.vy = -p.jump;
                    } else {
                        if(keys.ArrowLeft) { p.vx = -p.spd; p.dir = -1; } if(keys.ArrowRight) { p.vx = p.spd; p.dir = 1; }
                        if(keys.ArrowUp && p.vy === 0) p.vy = -p.jump;
                    }
                }
                p.update(); p.draw();
            });

            // Xử lý đệ tử
            minions.forEach((m, i) => {
                m.life--; let e = m.owner === 1 ? p2 : p1;
                m.x += (e.x - m.x) * 0.04; m.y += (e.y - m.y) * 0.04;
                ctx.fillStyle = 'rgba(168, 85, 247, 0.5)'; ctx.shadowBlur = 10; ctx.shadowColor = '#a855f7';
                ctx.fillRect(m.x, m.y, 40, 80); ctx.shadowBlur = 0;
                if(Math.abs(m.x - e.x) < 50) { e.hp -= 0.15; if(Math.random() > 0.95) snd(200, 'sine', 0.05, 0.05); }
                if(m.life <= 0) minions.splice(i, 1);
            });

            // Projectiles
            projectiles.forEach((proj, i) => {
                proj.x += proj.vx; proj.y += proj.vy;
                ctx.fillStyle = proj.type === 'fire' ? '#f50' : (proj.type === 'brick' ? '#744' : '#0cf');
                ctx.shadowBlur = 20; ctx.shadowColor = ctx.fillStyle;
                ctx.fillRect(proj.x, proj.y, 25, 25); ctx.shadowBlur = 0;
                let e = proj.owner === 1 ? p2 : p1;
                if(proj.x < e.x+e.w && proj.x+25 > e.x && proj.y < e.y+e.h && proj.y+25 > e.y) {
                    e.hp -= 15; e.stun = proj.type === 'brick' ? 5000 : 2500;
                    shake = 20; snd(80, 'square', 0.3); projectiles.splice(i, 1);
                } else if(proj.y > canvas.height) projectiles.splice(i, 1);
            });

            if(shake > 0) shake *= 0.9;
            document.getElementById('p1-hp').style.width = p1.hp + '%';
            document.getElementById('p2-hp').style.width = p2.hp + '%';
            document.getElementById('p1-mana').style.width = p1.mana + '%';
            document.getElementById('p2-mana').style.width = p2.mana + '%';

            if(p1.hp <= 0 || p2.hp <= 0) { 
                isRunning = false; snd(50, 'sawtooth', 2); 
                alert("FINISH HIM! TRẬN ĐẤU KẾT THÚC."); 
                location.reload(); 
            }
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
