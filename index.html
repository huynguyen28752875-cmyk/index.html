<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anh Ba ƒê·∫°i Chi·∫øn - Survival P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; background: #2c3e50; } /* S√†n ƒë·∫•u m√†u t·ªëi ƒë·ªÉ d·ªÖ nh√¨n b√°t ph·ªü */
        .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; padding: 15px; z-index: 20; }
        .pointer { pointer-events: auto; }
        .bar-container { width: 140px; height: 12px; background: #333; border-radius: 6px; border: 2px solid #555; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ff4b2b, #ff416c); transition: width 0.2s; }
        
        /* Joystick & Button */
        #ctrl-move { position: absolute; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.15); border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        #btn-shoot { position: absolute; bottom: 50px; right: 50px; width: 90px; height: 90px; background: #e74c3c; border-radius: 50%; color: #fff; font-weight: 900; pointer-events: auto; border: 5px solid #c0392b; box-shadow: 0 6px 0 #922b21; }
        #btn-shoot:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body>

    <div class="ui-overlay flex justify-between">
        <div class="bg-black/60 p-3 rounded-2xl border border-blue-500">
            <p class="text-blue-400 font-bold text-xs uppercase mb-1">Anh Ba (B·∫†N)</p>
            <div class="bar-container"><div id="my-hp" class="hp-fill" style="width: 100%;"></div></div>
            <p class="text-white text-[10px] mt-1 italic">M·∫°ng c√≤n l·∫°i: <span id="my-lives" class="text-yellow-400 font-bold">3</span></p>
        </div>

        <div class="pointer text-center">
            <div id="id-display" class="bg-yellow-500 text-black px-3 py-1 rounded-full text-[10px] font-black mb-2 shadow-lg">ID: ƒêang t·∫°o...</div>
            <input type="text" id="peer-id" placeholder="D√°n ID b·∫°n b√®" class="text-black text-[10px] p-2 rounded-lg w-32 border-none">
            <button onclick="connectToFriend()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-[10px] font-bold block mx-auto mt-2">K·∫æT N·ªêI</button>
        </div>

        <div class="bg-black/60 p-3 rounded-2xl border border-red-500 text-right">
            <p class="text-red-400 font-bold text-xs uppercase mb-1">ƒê·ªëi Th·ªß</p>
            <div class="bar-container ml-auto"><div id="peer-hp" class="hp-fill" style="width: 100%;"></div></div>
            <p class="text-white text-[10px] mt-1 italic">M·∫°ng c√≤n l·∫°i: <span id="peer-lives" class="text-yellow-400 font-bold">3</span></p>
        </div>
    </div>

    <div id="ctrl-move"><div id="stick"></div></div>
    <button id="btn-shoot">N√âM üçú</button>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const peer = new Peer();
        let conn;

        // Tr·∫°ng th√°i nh√¢n v·∫≠t
        let me = { x: 100, y: 100, hp: 100, lives: 3, size: 45, bullets: [] };
        let enemy = { x: -500, y: -500, hp: 100, lives: 3, bullets: [] };
        let moveX = 0, moveY = 0;

        peer.on('open', id => document.getElementById('id-display').innerText = "ID: " + id);
        peer.on('connection', c => { conn = c; initConnection(); });

        function connectToFriend() {
            conn = peer.connect(document.getElementById('peer-id').value);
            initConnection();
        }

        function initConnection() {
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy.x = data.x; enemy.y = data.y;
                    enemy.bullets = data.bullets;
                    enemy.hp = data.hp;
                    enemy.lives = data.lives;
                }
                if(data.type === 'damage') {
                    me.hp -= 10;
                    if(me.hp <= 0) doRespawn();
                }
            });
        }

        function doRespawn() {
            me.lives--;
            if(me.lives > 0) {
                me.hp = 100;
                me.x = Math.random() * (canvas.width - 50);
                me.y = Math.random() * (canvas.height - 50);
            } else {
                alert("B·∫†N ƒê√É H·∫æT M·∫†NG! THUA CU·ªòC.");
                location.reload();
            }
        }

        // Joystick x·ª≠ l√Ω di chuy·ªÉn n√© ƒë√≤n
        const joystick = document.getElementById('ctrl-move');
        const stick = document.getElementById('stick');
        joystick.addEventListener('touchmove', e => {
            const t = e.touches[0];
            const r = joystick.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 40) { dx *= 40/dist; dy *= 40/dist; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/6; moveY = dy/6; // T·ªëc ƒë·ªô di chuy·ªÉn
        });
        joystick.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });

        // T·∫•n c√¥ng
        document.getElementById('btn-shoot').addEventListener('click', () => {
            me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 12 });
        });

        function gameLoop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            
            // Di chuy·ªÉn & gi·ªõi h·∫°n m√†n h√¨nh
            me.x = Math.max(0, Math.min(canvas.width - me.size, me.x + moveX));
            me.y = Math.max(0, Math.min(canvas.height - me.size, me.y + moveY));

            // X·ª≠ l√Ω ƒë·∫°n c·ªßa m√¨nh
            me.bullets.forEach((b, i) => {
                b.x += b.vx;
                // Va ch·∫°m v·ªõi ƒê·ªãch (t√≠nh to√°n local)
                if(b.x > enemy.x && b.x < enemy.x + me.size && b.y > enemy.y && b.y < enemy.y + me.size) {
                    me.bullets.splice(i, 1);
                    if(conn) conn.send({ type: 'damage' });
                }
                if(b.x > canvas.width || b.x < 0) me.bullets.splice(i, 1);
            });

            // ƒê·ªìng b·ªô d·ªØ li·ªáu
            if(conn && conn.open) {
                conn.send({
                    type: 'sync',
                    x: canvas.width - me.x - me.size, // ƒê·∫£o t·ªça ƒë·ªô ƒë·ªÉ ƒë·ªëi th·ªß th·∫•y m√¨nh ·ªü h∆∞·ªõng ng∆∞·ª£c l·∫°i
                    y: me.y,
                    bullets: me.bullets.map(b => ({...b, x: canvas.width - b.x, vx: -b.vx})),
                    hp: me.hp,
                    lives: me.lives
                });
            }

            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            
            // V·∫Ω B·∫°n (Anh Ba Xanh)
            ctx.fillStyle = "#3498db";
            ctx.shadowBlur = 15; ctx.shadowColor = "#3498db";
            ctx.fillRect(me.x, me.y, me.size, me.size);
            
            // V·∫Ω ƒê·ªãch (Anh Ba ƒê·ªè)
            ctx.fillStyle = "#e74c3c";
            ctx.shadowColor = "#e74c3c";
            ctx.fillRect(enemy.x, enemy.y, me.size, me.size);

            // V·∫Ω b√°t ph·ªü
            ctx.shadowBlur = 0; ctx.font = "25px Arial";
            me.bullets.concat(enemy.bullets).forEach(b => ctx.fillText("üçú", b.x, b.y));

            // C·∫≠p nh·∫≠t UI
            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lives').innerText = me.lives;
            document.getElementById('peer-lives').innerText = enemy.lives;
        }

        gameLoop();
    </script>
</body>
</html>
