<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anh Ba ƒê·∫°i Chi·∫øn - ƒê·ªëi Kh√°ng P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Arial', sans-serif; touch-action: none; }
        canvas { display: block; background: #ecd9c6; }
        .ui { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; padding: 10px; }
        .pointer { pointer-events: auto; }
        .health-bar { width: 150px; height: 15px; background: #444; border: 2px solid white; border-radius: 10px; overflow: hidden; }
        .health-fill { height: 100%; background: #ef4444; transition: 0.3s; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; }
        #attack-btn { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: #ef4444; border-radius: 50%; color: white; font-weight: bold; pointer-events: auto; border: 4px solid #b91c1c; box-shadow: 0 5px 0 #7f1d1d; }
        #attack-btn:active { transform: translateY(5px); box-shadow: none; }
    </style>
</head>
<body>

    <div class="ui flex justify-between items-start text-white">
        <div class="bg-black/50 p-2 rounded">
            <p class="text-xs">B·∫†N (ANH BA 1)</p>
            <div class="health-bar"><div id="my-hp" class="health-fill" style="width: 100%;"></div></div>
            <p class="text-[10px]">M·∫°ng: <span id="my-lives">3</span>/3</p>
        </div>
        
        <div class="pointer bg-white/10 p-2 rounded text-center">
            <p class="text-[10px]">ID: <span id="my-id" class="font-bold text-yellow-400">ƒêang t·∫£i...</span></p>
            <input type="text" id="peer-id" placeholder="ID B·∫°n b√®" class="text-black text-[10px] p-1 rounded w-24">
            <button onclick="connect()" class="bg-blue-600 px-2 py-1 rounded text-[10px]">K·∫øt n·ªëi</button>
        </div>

        <div class="bg-black/50 p-2 rounded text-right">
            <p class="text-xs">ƒê·ªêI TH·ª¶</p>
            <div class="health-bar"><div id="peer-hp" class="health-fill" style="width: 100%;"></div></div>
            <p class="text-[10px]">M·∫°ng: <span id="peer-lives">3</span>/3</p>
        </div>
    </div>

    <div id="joystick"><div id="stick"></div></div>
    <button id="attack-btn" class="pointer shadow-lg">N√âM B√ÅT</button>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const peer = new Peer();
        let conn;

        let my = { x: 100, y: 300, hp: 100, lives: 3, color: '#3b82f6', bullets: [] };
        let enemy = { x: 500, y: 300, hp: 100, lives: 3, color: '#ef4444', bullets: [] };
        let moveX = 0, moveY = 0;

        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => { conn = c; setupConn(); });

        function connect() {
            conn = peer.connect(document.getElementById('peer-id').value);
            setupConn();
        }

        function setupConn() {
            conn.on('data', data => {
                if(data.type === 'move') {
                    enemy.x = data.x; enemy.y = data.y;
                    enemy.bullets = data.bullets;
                }
                if(data.type === 'hit') {
                    my.hp = data.newHp;
                    if(my.hp <= 0) respawn();
                }
            });
        }

        function respawn() {
            my.lives--;
            document.getElementById('my-lives').innerText = my.lives;
            if(my.lives > 0) {
                my.hp = 100;
                my.x = Math.random() * 200;
                my.y = Math.random() * 400;
                alert("B·∫°n ƒë√£ b·ªã h·∫° g·ª•c! ƒêang h·ªìi sinh...");
            } else {
                alert("GAME OVER! B·∫†N ƒê√É THUA.");
                location.reload();
            }
        }

        // Joystick Logic
        const joy = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const touch = e.touches[0];
            const r = joy.getBoundingClientRect();
            let dx = touch.clientX - (r.left + 50), dy = touch.clientY - (r.top + 50);
            const d = Math.sqrt(dx*dx + dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/8; moveY = dy/8;
        });
        joy.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });

        // T·∫•n c√¥ng
        document.getElementById('attack-btn').addEventListener('click', () => {
            my.bullets.push({ x: my.x + 20, y: my.y + 20, vx: 10 });
        });

        function update() {
            my.x += moveX; my.y += moveY;
            
            // X·ª≠ l√Ω b√°t ph·ªü c·ªßa m√¨nh
            my.bullets.forEach((b, i) => {
                b.x += b.vx;
                // Ki·ªÉm tra b·∫Øn tr√∫ng ƒë·ªãch (ch·ªâ t√≠nh tr√™n m√°y m√¨nh)
                if(b.x > enemy.x && b.x < enemy.x + 40 && b.y > enemy.y && b.y < enemy.y + 40) {
                    enemy.hp -= 10;
                    my.bullets.splice(i, 1);
                    if(conn) conn.send({ type: 'hit', newHp: enemy.hp });
                }
                if(b.x > canvas.width) my.bullets.splice(i, 1);
            });

            if(conn) conn.send({ type: 'move', x: canvas.width - my.x - 40, y: my.y, bullets: my.bullets.map(b => ({...b, x: canvas.width - b.x, vx: -b.vx})) });
            
            document.getElementById('my-hp').style.width = my.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('peer-lives').innerText = enemy.lives;
        }

        function draw() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            ctx.clearRect(0,0, canvas.width, canvas.height);

            // V·∫Ω B·∫°n
            ctx.fillStyle = my.color;
            ctx.fillRect(my.x, my.y, 40, 40);
            ctx.fillStyle = "black"; ctx.fillText("B·∫†N", my.x, my.y - 5);

            // V·∫Ω ƒê·ªãch
            ctx.fillStyle = enemy.color;
            ctx.fillRect(enemy.x, enemy.y, 40, 40);
            ctx.fillStyle = "black"; ctx.fillText("ƒê·ªêI TH·ª¶", enemy.x, enemy.y - 5);

            // V·∫Ω b√°t ph·ªü (ƒë·∫°n)
            ctx.font = "20px Arial";
            my.bullets.concat(enemy.bullets).forEach(b => ctx.fillText("üçú", b.x, b.y));

            update();
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
