<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zom-Evo: Dark Survival</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }
        
        /* Rotate Hint */
        #rotate-hint { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        @media screen and (orientation: portrait) { #rotate-hint { display: flex; } }

        .ui-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .skill-btn { background: #312e81; border: 2px solid #6366f1; padding: 15px; border-radius: 12px; width: 220px; transition: 0.2s; cursor: pointer; }
        .skill-btn:active { transform: scale(0.95); background: #6366f1; }
        
        #hud { position: absolute; top: 0; width: 100%; padding: 20px; pointer-events: none; z-index: 50; display: flex; justify-content: space-between; color: white; }
        #combo-txt { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 40px; color: #fbbf24; font-weight: 900; opacity: 0; transition: 0.3s; }
        
        /* Mobile Controls */
        #joystick { position: absolute; bottom: 40px; left: 60px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(99,102,241,0.3); }
        #stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #6366f1; border-radius: 50%; box-shadow: 0 0 20px #6366f1; }
        #btn-shoot { position: absolute; bottom: 50px; right: 60px; width: 100px; height: 100px; background: #ef4444; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 0 20px #ef4444; color: white; font-weight: 900; z-index: 100; }
    </style>
</head>
<body>

    <div id="rotate-hint">üîÑ Xoay ngang ƒëi·ªán tho·∫°i ƒë·ªÉ ch∆°i</div>

    <div id="setup" class="ui-screen">
        <h1 class="text-6xl font-black text-red-600 mb-2 italic shadow-lg">DARK SURVIVAL</h1>
        <p class="text-indigo-400 mb-8 tracking-widest text-sm">H·ª¢P T√ÅC SINH T·ªíN 360¬∞</p>
        <div class="flex flex-col gap-4">
            <input type="text" id="name-in" class="p-4 rounded-xl text-black font-bold w-80" placeholder="T√™n c·ªßa b·∫°n">
            <input type="text" id="room-in" class="p-4 rounded-xl text-black font-bold w-80" placeholder="M√£ ph√≤ng (V√≠ d·ª•: 999)">
            <button onclick="initPeer()" class="bg-red-600 py-4 rounded-xl font-black text-2xl active:scale-95 shadow-xl">V√ÄO TR·∫¨N CHI·∫æN</button>
        </div>
        <p id="status" class="mt-4 text-gray-500 italic text-sm"></p>
    </div>

    <div id="upgrade-menu" class="ui-screen hidden">
        <h2 class="text-3xl font-black text-yellow-400 mb-8">K·ª∏ NƒÇNG TI·∫æN H√ìA</h2>
        <div id="skill-options" class="flex flex-wrap justify-center gap-4"></div>
    </div>

    <div id="hud" class="hidden">
        <div class="flex flex-col gap-1">
            <p id="ui-name" class="font-bold text-indigo-400"></p>
            <div class="w-32 h-3 bg-gray-900 rounded-full border border-gray-700 overflow-hidden"><div id="hp-bar" class="h-full bg-red-600 transition-all"></div></div>
            <p class="text-[10px] text-gray-500 uppercase">Drone: <span id="ui-drone" class="text-green-500">S·∫¥N S√ÄNG</span></p>
        </div>
        <div class="text-right">
            <p id="ui-score" class="text-4xl font-black text-white">0</p>
            <p class="text-xs text-indigo-400">STAGE <span id="ui-stage">1</span></p>
        </div>
    </div>

    <div id="combo-txt">UNSTOPPABLE!</div>
    <div id="joystick"><div id="stick"></div></div>
    <button id="btn-shoot">B·∫ÆN</button>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let peer, conn, isHost = false;

        // --- GAME OBJECTS ---
        let me = { 
            x: 400, y: 300, hp: 100, score: 0, stage: 1, angle: 0, speed: 5, fireRate: 350,
            droneAngle: 0, hasDrone: true, lastShoot: 0, combo: 0, comboTimer: 0
        };
        let enemy = { x: -1000, y: -1000, hp: 100, angle: 0, bullets: [] };
        let zombies = [], particles = [], bullets = [], boss = null;
        let joyX = 0, joyY = 0;

        function initPeer() {
            const name = document.getElementById('name-in').value || "Soldier";
            const room = 'dark-zom-' + (document.getElementById('room-in').value || "test");
            document.getElementById('ui-name').innerText = name.toUpperCase();
            
            peer = new Peer(room);
            peer.on('open', (id) => { 
                isHost = true; 
                document.getElementById('status').innerText = "ƒê√£ m·ªü ph√≤ng. Ch·ªù ƒë·ªìng ƒë·ªôi..."; 
            });
            peer.on('connection', c => { conn = c; start(); });
            peer.on('error', () => {
                peer = new Peer();
                setTimeout(() => { conn = peer.connect(room); start(); }, 500);
            });
        }

        function start() {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('hud').classList.remove('hidden');
            loop();
        }

        function createBullet(x, y, angle, isDrone = false) {
            bullets.push({
                x: x, y: y,
                vx: Math.cos(angle) * 15,
                vy: Math.sin(angle) * 15,
                power: isDrone ? 15 : 25,
                color: isDrone ? '#4ade80' : '#fbbf24'
            });
        }

        function spawnZombie() {
            if(!isHost) return;
            if(zombies.length < 5 + me.stage * 2) {
                const side = Math.random() > 0.5;
                zombies.push({
                    id: Date.now() + Math.random(),
                    x: side ? Math.random() * canvas.width : (Math.random() > 0.5 ? -50 : canvas.width + 50),
                    y: !side ? Math.random() * canvas.height : (Math.random() > 0.5 ? -50 : canvas.height + 50),
                    hp: 50 + (me.stage * 15),
                    type: Math.random() > 0.85 ? 'fast' : 'normal'
                });
            }
        }

        function handleUpgrades() {
            me.stage++;
            const upgrades = [
                { t: "‚ö° T·ªêC ƒê·ªò", d: "Ch·∫°y nhanh h∆°n", fn: () => me.speed += 1.5 },
                { t: "üî• LI√äN THANH", d: "B·∫Øn nhanh h∆°n 40%", fn: () => me.fireRate *= 0.6 },
                { t: "üõ° GI√ÅP", d: "H·ªìi m√°u t·ªëi ƒëa", fn: () => me.hp = 100 }
            ];
            const container = document.getElementById('skill-options');
            container.innerHTML = '';
            upgrades.forEach(u => {
                const btn = document.createElement('div');
                btn.className = 'skill-btn';
                btn.innerHTML = `<p class="font-black text-yellow-400">${u.t}</p><p class="text-[10px]">${u.d}</p>`;
                btn.onclick = () => { u.fn(); document.getElementById('upgrade-menu').classList.add('hidden'); };
                container.appendChild(btn);
            });
            document.getElementById('upgrade-menu').classList.remove('hidden');
        }

        function loop() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const isPaused = !document.getElementById('upgrade-menu').classList.contains('hidden');

            if(!me.isDead && !isPaused) {
                // Di chuy·ªÉn
                if(Math.abs(joyX) > 0.1 || Math.abs(joyY) > 0.1) {
                    me.x += joyX * me.speed;
                    me.y += joyY * me.speed;
                    me.angle = Math.atan2(joyY, joyX);
                }

                // Drone Logic
                me.droneAngle += 0.05;
                const dx = me.x + 20 + Math.cos(me.droneAngle) * 60;
                const dy = me.y + 20 + Math.sin(me.droneAngle) * 60;

                // T·ª± ƒë·ªông b·∫Øn Drone
                if(zombies.length > 0 && Math.random() < 0.03) {
                    const target = zombies[0];
                    const angleToZom = Math.atan2(target.y - dy, target.x - dx);
                    createBullet(dx, dy, angleToZom, true);
                }

                // Combo Timer
                if(me.comboTimer > 0) {
                    me.comboTimer--;
                    if(me.comboTimer === 0) me.combo = 0;
                }
            }

            if(isHost && !isPaused) {
                spawnZombie();
                zombies.forEach(z => {
                    const d = Math.sqrt((me.x-z.x)**2 + (me.y-z.y)**2);
                    const zSpeed = z.type === 'fast' ? 2.5 : 1.5;
                    z.x += (me.x-z.x)/d * (zSpeed + me.stage*0.1);
                    z.y += (me.y-z.y)/d * (zSpeed + me.stage*0.1);
                });
            }

            // X·ª≠ l√Ω ƒë·∫°n
            bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                if(b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) bullets.splice(i, 1);
                
                zombies.forEach((z, zi) => {
                    if(Math.sqrt((b.x-z.x)**2 + (b.y-z.y)**2) < 25) {
                        z.hp -= b.power;
                        bullets.splice(i, 1);
                        if(z.hp <= 0) {
                            zombies.splice(zi, 1);
                            me.score += 100;
                            me.combo++;
                            me.comboTimer = 100;
                            if(me.combo % 5 === 0) showCombo();
                            if(me.score % 1000 === 0) handleUpgrades();
                        }
                    }
                });
            });

            if(conn && conn.open) conn.send({ type: 'sync', player: me, bullets, zombies, stage: me.stage });

            draw();
            requestAnimationFrame(loop);
        }

        function showCombo() {
            const el = document.getElementById('combo-txt');
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 800);
        }

        function draw() {
            // Ph√¥ng n·ªÅn t·ªëi
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // --- L·ªöP √ÅNH S√ÅNG (FLASHLIGHT) ---
            ctx.save();
            ctx.beginPath();
            ctx.arc(me.x+20, me.y+20, 350, me.angle - 0.5, me.angle + 0.5);
            ctx.lineTo(me.x+20, me.y+20);
            ctx.clip();
            
            // V·∫Ω m·∫∑t ƒë·∫•t trong v√πng s√°ng
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // V·∫Ω Zombies trong v√πng s√°ng
            zombies.forEach(z => {
                ctx.fillStyle = z.type === 'fast' ? '#f87171' : '#22c55e';
                ctx.beginPath(); ctx.arc(z.x+20, z.y+20, 20, 0, 7); ctx.fill();
                ctx.fillStyle = 'white'; ctx.fillRect(z.x+10, z.y+10, 4, 4); ctx.fillRect(z.x+25, z.y+10, 4, 4);
            });
            ctx.restore();

            // V·∫Ω Drone
            const dx = me.x + 20 + Math.cos(me.droneAngle) * 60;
            const dy = me.y + 20 + Math.sin(me.droneAngle) * 60;
            ctx.fillStyle = '#4ade80';
            ctx.shadowBlur = 15; ctx.shadowColor = '#4ade80';
            ctx.fillRect(dx-10, dy-10, 20, 20);
            ctx.shadowBlur = 0;

            // V·∫Ω Nh√¢n v·∫≠t ch√≠nh
            ctx.save();
            ctx.translate(me.x + 20, me.y + 20);
            ctx.rotate(me.angle);
            ctx.fillStyle = '#6366f1';
            ctx.fillRect(-20, -20, 40, 40);
            ctx.fillStyle = 'white'; ctx.fillRect(10, -4, 15, 8); // S√∫ng
            ctx.restore();

            // V·∫Ω ƒê·∫°n (Lu√¥n th·∫•y trong b√≥ng t·ªëi v√¨ n√≥ t·ª± ph√°t s√°ng)
            bullets.forEach(b => {
                ctx.fillStyle = b.color;
                ctx.shadowBlur = 10; ctx.shadowColor = b.color;
                ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, 7); ctx.fill();
                ctx.shadowBlur = 0;
            });

            // HUD Update
            document.getElementById('hp-bar').style.width = me.hp + '%';
            document.getElementById('ui-score').innerText = me.score;
            document.getElementById('ui-stage').innerText = me.stage;
        }

        // --- CONTROLS ---
        const joy = document.getElementById('joystick'), st = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
            let d = Math.sqrt(dx*dx + dy*dy); if(d > 45) { dx *= 45/d; dy *= 45/d; }
            st.style.transform = `translate(${dx}px, ${dy}px)`; 
            joyX = dx/45; joyY = dy/45;
        });
        joy.addEventListener('touchend', () => { joyX = 0; joyY = 0; st.style.transform = 'none'; });
        
        document.getElementById('btn-shoot').addEventListener('touchstart', (e) => {
            e.preventDefault();
            const now = Date.now();
            if(now - me.lastShoot > me.fireRate) {
                createBullet(me.x+20, me.y+20, me.angle);
                me.lastShoot = now;
            }
        });
    </script>
</body>
</html>
