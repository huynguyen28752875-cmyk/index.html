<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Street Fighters VN: 5 Legends</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; }
        canvas { display: block; }
        #lobby { position: absolute; inset: 0; background: radial-gradient(circle, #1e293b, #020617); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 20px; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 600px; }
        .char-btn { border: 3px solid #444; padding: 10px; background: rgba(255,255,255,0.05); text-align: center; border-radius: 10px; transition: 0.2s; cursor: pointer; }
        .active:hover { border-color: #facc15; transform: scale(1.05); }
        .p1-selected { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.2); }
        .p2-selected { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.2); }
        .locked { opacity: 0.3; pointer-events: none; }
        
        #controls { position: absolute; bottom: 20px; width: 100%; display: none; justify-content: space-between; padding: 0 20px; z-index: 50; pointer-events: none; }
        .btn-group { display: flex; gap: 10px; pointer-events: auto; }
        .joy-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; user-select: none; }
        
        #game-ui { position: absolute; top: 20px; width: 100%; display: none; justify-content: space-around; z-index: 10; }
        .bar-wrap { width: 35%; }
        .hp-out { height: 20px; background: #222; border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        .hp-in { height: 100%; background: #ff0000; width: 100%; transition: 0.1s; }
        .mana-out { height: 8px; background: #111; border: 1px solid #0cf; margin-top: 4px; border-radius: 5px; }
        .mana-in { height: 100%; background: #00f2ff; width: 0%; transition: 0.2s; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 id="turn-text" class="text-3xl text-yellow-400 mb-6 italic text-center">P1 CHỌN NHÂN VẬT</h1>
        <div class="char-grid" id="grid"></div>
    </div>

    <div id="game-ui">
        <div class="bar-wrap">
            <div class="hp-out"><div id="p1-hp" class="hp-in"></div></div>
            <div class="mana-out"><div id="p1-mana" class="mana-in"></div></div>
            <div id="p1-name" class="text-xs mt-1">P1</div>
        </div>
        <div class="bar-wrap">
            <div class="hp-out"><div id="p2-hp" class="hp-in" style="float:right"></div></div>
            <div class="mana-out"><div id="p2-mana" class="mana-in" style="float:right"></div></div>
            <div id="p2-name" class="text-xs mt-1 text-right">P2</div>
        </div>
    </div>

    <div id="controls">
        <div class="btn-group">
            <div class="joy-btn" onpointerdown="keys.KeyA=true" onpointerup="keys.KeyA=false">←</div>
            <div class="joy-btn" onpointerdown="keys.KeyW=true" onpointerup="keys.KeyW=false">↑</div>
            <div class="joy-btn" onpointerdown="keys.KeyD=true" onpointerup="keys.KeyD=false">→</div>
        </div>
        <div class="btn-group">
            <div class="joy-btn bg-blue-600" onpointerdown="p1.attack('Punch')">P</div>
            <div class="joy-btn bg-red-600" onpointerdown="p1.attack('Kick')">K</div>
            <div class="joy-btn bg-yellow-600" onpointerdown="p1.attack('Ulti')">U</div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const chars = [
            { id: 'DanChoi', name: 'DÂN CHƠI', color: '#3b82f6', skill: 'Mưa Lửa' },
            { id: 'HiepSi', name: 'HIỆP SĨ', color: '#ef4444', skill: 'Mưa Tên' },
            { id: 'BO', name: 'CỤ BO', color: '#a855f7', skill: 'Đệ Tử' },
            { id: 'Bin', name: 'BIN', color: '#10b981', skill: 'Ném Gạch' },
            { id: 'Son', name: 'SƠN', color: '#f97316', skill: 'Tốc Biến' }
        ];

        let p1Char, p2Char, p1, p2, isRunning = false, keys = {}, projectiles = [], minions = [];

        // Tạo sảnh chọn tướng
        const grid = document.getElementById('grid');
        chars.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'char-btn active';
            btn.id = 'btn-' + c.id;
            btn.innerHTML = `<div style="color:${c.color}">${c.name}</div><div class="text-[10px] text-gray-400">${c.skill}</div>`;
            btn.onclick = () => pick(c.id);
            grid.appendChild(btn);
        });

        function pick(id) {
            if(!p1Char) {
                p1Char = id; document.getElementById('btn-'+id).classList.add('p1-selected', 'locked');
                document.getElementById('turn-text').innerText = "P2 CHỌN NHÂN VẬT";
            } else if(!p2Char) {
                p2Char = id; document.getElementById('btn-'+id).classList.add('p2-selected', 'locked');
                setTimeout(start, 500);
            }
        }

        function start() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            if('ontouchstart' in window) document.getElementById('controls').style.display = 'flex';
            p1 = new Fighter(200, 1, p1Char);
            p2 = new Fighter(window.innerWidth - 200, 2, p2Char);
            isRunning = true;
        }

        class Fighter {
            constructor(x, id, type) {
                this.x = x; this.id = id; this.type = type;
                this.hp = 100; this.maxHp = 100; this.mana = 0;
                this.w = 60; this.h = 130; this.vy = 0; this.vx = 0;
                this.dir = id === 1 ? 1 : -1; this.isAtk = 0; this.stun = 0;
                this.color = chars.find(c => c.id === type).color;
            }
            draw() {
                ctx.fillStyle = this.stun > 0 ? '#555' : this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                if(this.isAtk > 0) { ctx.fillStyle = "#fff"; ctx.fillRect(this.x + (this.dir > 0 ? this.w : -40), this.y + 40, 40, 20); this.isAtk--; }
            }
            update() {
                if(this.stun > 0) { this.stun -= 16; return; }
                this.x += this.vx; this.y += this.vy;
                if(this.y + this.h < canvas.height - 50) this.vy += 1;
                else { this.y = canvas.height - 50 - this.h; this.vy = 0; }
                this.mana = Math.min(100, this.mana + 0.1);
            }
            attack(t) {
                if(this.isAtk > 0 || this.stun > 0) return;
                if(t === 'Ulti' && this.mana < 100) return;
                
                if(t === 'Ulti') {
                    this.mana = 0;
                    if(this.type === 'BO') {
                        for(let i=0; i<5; i++) minions.push({ x: this.x, y: this.y, hp: 50, owner: this.id, life: 600 });
                    } else if(this.type === 'Bin') {
                        projectiles.push({ x: this.x, y: this.y, vx: this.dir * 15, vy: -5, type: 'brick', owner: this.id });
                    } else if(this.type === 'DanChoi' || this.type === 'HiepSi') {
                        for(let i=0; i<8; i++) projectiles.push({ x: Math.random()*canvas.width, y: -50, vx: 0, vy: 10, type: this.type==='DanChoi'?'fire':'arrow', owner: this.id });
                    } else if(this.type === 'Son') {
                        let enemy = this.id === 1 ? p2 : p1;
                        this.x = enemy.x - (enemy.dir * 80); this.attack('Kick');
                    }
                    return;
                }
                
                this.isAtk = 10;
                let enemy = this.id === 1 ? p2 : p1;
                if(Math.abs(this.x - enemy.x) < 100 && Math.abs(this.y - enemy.y) < 100) {
                    enemy.hp -= 10; this.mana = Math.min(100, this.mana + 15);
                }
            }
        }

        window.onkeydown = e => { 
            keys[e.code] = true; 
            if(e.code === 'KeyF') p1.attack('Punch'); if(e.code === 'KeyG') p1.attack('Kick'); if(e.code === 'KeyH') p1.attack('Ulti');
            if(e.code === 'KeyK') p2.attack('Punch'); if(e.code === 'KeyL') p2.attack('Kick'); if(e.code === 'KeyJ') p2.attack('Ulti');
        };
        window.onkeyup = e => keys[e.code] = false;

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!isRunning) return requestAnimationFrame(loop);
            ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, canvas.height-50, canvas.width, 50);

            [p1, p2].forEach(p => {
                if(p.stun <= 0) {
                    p.vx = 0;
                    if(p.id === 1) {
                        if(keys.KeyA) { p.vx = -7; p.dir = -1; } if(keys.KeyD) { p.vx = 7; p.dir = 1; }
                        if(keys.KeyW && p.vy === 0) p.vy = -20;
                    } else {
                        if(keys.ArrowLeft) { p.vx = -7; p.dir = -1; } if(keys.ArrowRight) { p.vx = 7; p.dir = 1; }
                        if(keys.ArrowUp && p.vy === 0) p.vy = -20;
                    }
                }
                p.update(); p.draw();
            });

            // Đệ tử của BO
            minions.forEach((m, i) => {
                m.life--; let enemy = m.owner === 1 ? p2 : p1;
                m.x += (enemy.x - m.x) * 0.05; m.y += (enemy.y - m.y) * 0.05;
                ctx.fillStyle = 'rgba(168, 85, 247, 0.6)'; ctx.fillRect(m.x, m.y, 30, 60);
                if(Math.abs(m.x - enemy.x) < 40) { enemy.hp -= 0.1; }
                if(m.life <= 0 || m.hp <= 0) minions.splice(i, 1);
            });

            // Vật phẩm/Chiêu thức bay
            projectiles.forEach((proj, i) => {
                proj.x += proj.vx; proj.y += proj.vy;
                ctx.fillStyle = proj.type === 'fire' ? '#f50' : (proj.type === 'brick' ? '#744' : '#0cf');
                ctx.fillRect(proj.x, proj.y, 20, 20);
                let enemy = proj.owner === 1 ? p2 : p1;
                if(proj.x < enemy.x + enemy.w && proj.x + 20 > enemy.x && proj.y < enemy.y + enemy.h && proj.y + 20 > enemy.y) {
                    enemy.hp -= 15; if(proj.type === 'brick') enemy.stun = 5000; else enemy.stun = 2000;
                    projectiles.splice(i, 1);
                } else if(proj.y > canvas.height || proj.x < 0 || proj.x > canvas.width) projectiles.splice(i, 1);
            });

            document.getElementById('p1-hp').style.width = p1.hp + '%';
            document.getElementById('p2-hp').style.width = p2.hp + '%';
            document.getElementById('p1-mana').style.width = p1.mana + '%';
            document.getElementById('p2-mana').style.width = p2.mana + '%';

            if(p1.hp <= 0 || p2.hp <= 0) { isRunning = false; alert("KẾT THÚC!"); location.reload(); }
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
