<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu√°n Ph·ªü Anh Ba - RPG Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Arial', sans-serif; touch-action: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .pointer { pointer-events: auto; }
        
        /* Joystick Style */
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        #joystick-stick { width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.1s; }
        
        canvas { display: block; background: #8b4513; } /* N·ªÅn g·ªó */
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="p-4 flex justify-between">
            <div class="bg-black/50 text-white p-2 rounded border-2 border-yellow-600">
                üí∞ Ti·ªÅn: <span id="money">0</span>ƒë
            </div>
            <button onclick="toggleMusic()" class="pointer bg-white p-2 rounded-full w-10 h-10 flex items-center justify-center shadow-lg">üéµ</button>
        </div>

        <div id="joystick-container">
            <div id="joystick-stick"></div>
        </div>
        
        <div id="msg-box" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/90 p-4 rounded-xl hidden text-center font-bold">
            "Cho con m·ªôt t√¥ kh√¥ng h√†nh!"
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <audio id="bgMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const moneyEl = document.getElementById('money');
        
        let width, height;
        let money = 0;
        let musicPlaying = false;

        // C·∫•u h√¨nh nh√¢n v·∫≠t Anh Ba
        const player = {
            x: 100, y: 100, size: 40, speed: 4, color: '#3b82f6',
            vx: 0, vy: 0, 
            hasPho: false
        };

        // C·∫•u h√¨nh v·∫≠t th·ªÉ trong qu√°n
        const objects = [
            { name: "Qu·∫ßy N∆∞·ªõc D√πng", x: 50, y: 250, w: 100, h: 60, color: '#ef4444', type: 'kitchen' },
            { name: "B√†n Kh√°ch", x: 400, y: 150, w: 80, h: 80, color: '#fde68a', type: 'table', hasGuest: true }
        ];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // X·ª≠ l√Ω Joystick
        const joystick = document.getElementById('joystick-container');
        const stick = document.getElementById('joystick-stick');
        let isDragging = false;

        joystick.addEventListener('touchstart', e => { isDragging = true; });
        window.addEventListener('touchmove', e => {
            if (!isDragging) return;
            const touch = e.touches[0];
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const maxDist = rect.width / 2;

            if (dist > maxDist) {
                dx *= maxDist / dist;
                dy *= maxDist / dist;
            }

            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            player.vx = (dx / maxDist) * player.speed;
            player.vy = (dy / maxDist) * player.speed;
        });
        window.addEventListener('touchend', () => {
            isDragging = false;
            stick.style.transform = `translate(0, 0)`;
            player.vx = 0; player.vy = 0;
        });

        // X·ª≠ l√Ω ph√≠m m√°y t√≠nh
        window.addEventListener('keydown', e => {
            if (e.key === 'w' || e.key === 'ArrowUp') player.vy = -player.speed;
            if (e.key === 's' || e.key === 'ArrowDown') player.vy = player.speed;
            if (e.key === 'a' || e.key === 'ArrowLeft') player.vx = -player.speed;
            if (e.key === 'd' || e.key === 'ArrowRight') player.vx = player.speed;
        });
        window.addEventListener('keyup', e => {
            if (['w', 's', 'ArrowUp', 'ArrowDown'].includes(e.key)) player.vy = 0;
            if (['a', 'd', 'ArrowLeft', 'ArrowRight'].includes(e.key)) player.vx = 0;
        });

        function toggleMusic() {
            const m = document.getElementById('bgMusic');
            if (!musicPlaying) { m.play(); musicPlaying = true; }
            else { m.pause(); musicPlaying = false; }
        }

        function update() {
            player.x += player.vx;
            player.y += player.vy;

            // Ch·∫∑n t∆∞·ªùng
            player.x = Math.max(0, Math.min(width - player.size, player.x));
            player.y = Math.max(0, Math.min(height - player.size, player.y));

            // Ki·ªÉm tra va ch·∫°m v·∫≠t th·ªÉ
            objects.forEach(obj => {
                if (player.x < obj.x + obj.w && player.x + player.size > obj.x &&
                    player.y < obj.y + obj.h && player.y + player.size > obj.y) {
                    
                    if (obj.type === 'kitchen' && !player.hasPho) {
                        player.hasPho = true;
                        document.getElementById('msg-box').innerText = "ƒê√£ n·∫•u xong! Mang ra cho kh√°ch.";
                        document.getElementById('msg-box').classList.remove('hidden');
                        setTimeout(() => document.getElementById('msg-box').classList.add('hidden'), 2000);
                    }
                    
                    if (obj.type === 'table' && player.hasPho) {
                        player.hasPho = false;
                        money += 50000;
                        moneyEl.innerText = money.toLocaleString();
                        document.getElementById('msg-box').innerText = "+50.000ƒë! Ph·ªü kh√¥ng h√†nh chu·∫©n v·ªã!";
                        document.getElementById('msg-box').classList.remove('hidden');
                        setTimeout(() => document.getElementById('msg-box').classList.add('hidden'), 2000);
                    }
                }
            });
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // V·∫Ω s√†n g·∫°ch
            ctx.strokeStyle = "rgba(0,0,0,0.1)";
            for(let i=0; i<width; i+=40) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,height); ctx.stroke();
            }
            for(let i=0; i<height; i+=40) {
                ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(width,i); ctx.stroke();
            }

            // V·∫Ω v·∫≠t th·ªÉ
            objects.forEach(obj => {
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                ctx.fillStyle = "#000";
                ctx.font = "12px Arial";
                ctx.fillText(obj.name, obj.x, obj.y - 5);
                
                if (obj.type === 'table') {
                    ctx.fillText("üë®‚Äçüíº Kh√°ch ƒëang ch·ªù", obj.x, obj.y + obj.h + 15);
                }
            });

            // V·∫Ω nh√¢n v·∫≠t Anh Ba
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x + player.size/2, player.y + player.size/2, player.size/2, 0, Math.PI*2);
            ctx.fill();
            
            // V·∫Ω b√°t ph·ªü n·∫øu ƒëang c·∫ßm
            if (player.hasPho) {
                ctx.font = "20px Arial";
                ctx.fillText("üçú", player.x + 10, player.y - 10);
            }

            ctx.fillStyle = "white";
            ctx.font = "bold 12px Arial";
            ctx.fillText("ANH BA", player.x, player.y + player.size + 15);

            requestAnimationFrame(() => {
                update();
                draw();
            });
        }

        draw();
    </script>
</body>
</html>
