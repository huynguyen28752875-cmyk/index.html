<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu√°n Ph·ªü Anh Ba - Si√™u K·∫øt N·ªëi</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #111; touch-action: none; font-family: sans-serif; }
        canvas { display: block; background: #2c3e50; }
        .setup-overlay { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #555; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        .action-btn { position: absolute; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 4px solid rgba(0,0,0,0.2); }
        #btn-shoot { bottom: 40px; right: 40px; width: 80px; height: 80px; background: #e74c3c; }
        #btn-dash { bottom: 130px; right: 50px; width: 60px; height: 60px; background: #3498db; }
    </style>
</head>
<body>

    <div id="setup-screen" class="setup-overlay">
        <h1 class="text-4xl font-black text-yellow-500 mb-2 italic text-center">ANH BA ONLINE</h1>
        <p class="text-sm mb-8 text-gray-400">Nh·∫≠p t√™n ph√≤ng gi·ªëng nhau ƒë·ªÉ g·∫∑p nhau</p>
        <input type="text" id="room-input" class="p-4 rounded-xl w-72 text-black font-bold mb-4 text-center outline-none border-4 border-yellow-600" placeholder="V√≠ d·ª•: anhba1">
        <button onclick="initGame()" id="start-btn" class="bg-green-600 px-12 py-4 rounded-2xl font-black text-xl hover:bg-green-500 active:scale-95 transition-all shadow-lg shadow-green-900/50">V√ÄO CHI·∫æN</button>
        <p id="status" class="mt-6 text-blue-400 font-medium animate-pulse"></p>
    </div>

    <div id="game-ui" class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none hidden">
        <div class="bg-black/70 p-2 rounded-lg border-l-4 border-blue-500">
            <p class="text-[10px] text-blue-400 font-bold">ANH BA (B·∫†N)</p>
            <div class="w-24 h-2 bg-gray-800 rounded-full overflow-hidden mt-1">
                <div id="my-hp" class="h-full bg-green-500 transition-all" style="width: 100%;"></div>
            </div>
            <p class="text-white text-[9px] mt-1">‚ù§Ô∏è M·∫†NG: <span id="my-lives">3</span></p>
        </div>
        <div class="bg-black/70 p-2 rounded-lg border-r-4 border-red-500 text-right">
            <p class="text-[10px] text-red-400 font-bold">ƒê·ªêI TH·ª¶</p>
            <div class="w-24 h-2 bg-gray-800 rounded-full overflow-hidden mt-1 ml-auto">
                <div id="peer-hp" class="h-full bg-red-500 transition-all" style="width: 0%;"></div>
            </div>
            <p class="text-white text-[9px] mt-1">‚ù§Ô∏è M·∫†NG: <span id="peer-lives">3</span></p>
        </div>
    </div>

    <div id="controls" class="hidden">
        <div id="joystick"><div id="stick"></div></div>
        <button id="btn-shoot" class="action-btn shadow-lg">N√âM üçú</button>
        <button id="btn-dash" class="action-btn shadow-lg">L∆Ø·ªöT</button>
    </div>
    
    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        let peer, conn, roomName;

        let me = { x: 100, y: 100, hp: 100, lives: 3, bullets: [] };
        let enemy = { x: -1000, y: -1000, hp: 100, lives: 3, bullets: [] };
        let moveX = 0, moveY = 0;

        function initGame() {
            const input = document.getElementById('room-input').value.trim();
            if (!input) return alert("B·∫°n ch∆∞a nh·∫≠p t√™n ph√≤ng!");
            roomName = 'aba-' + input.toLowerCase();
            statusEl.innerText = "ƒêang t√¨m ph√≤ng...";
            document.getElementById('start-btn').disabled = true;

            // B∆∞·ªõc 1: Th·ª≠ l√†m Host
            peer = new Peer(roomName);

            peer.on('open', (id) => {
                statusEl.innerText = "Ph√≤ng ƒë√£ m·ªü! Ch·ªù ƒë·ªëi th·ªß v√†o...";
                document.getElementById('game-ui').classList.remove('hidden');
                document.getElementById('controls').classList.remove('hidden');
            });

            // B∆∞·ªõc 2: N·∫øu ph√≤ng ƒë√£ c√≥ Host, t·ª± ƒë·ªông chuy·ªÉn sang l√†m Guest
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    statusEl.innerText = "Ph√≤ng ƒë√£ c√≥ ch·ªß, ƒëang k·∫øt n·ªëi th√°ch ƒë·∫•u...";
                    peer.destroy();
                    
                    // T·∫°o ID ng·∫´u nhi√™n cho m√¨nh ƒë·ªÉ tr√°nh tranh ch·∫•p
                    peer = new Peer();
                    peer.on('open', () => {
                        conn = peer.connect(roomName);
                        setupEvents();
                    });
                } else {
                    alert("L·ªói k·∫øt n·ªëi: " + err.type);
                    location.reload();
                }
            });

            // B∆∞·ªõc 3: Host nh·∫≠n k·∫øt n·ªëi t·ª´ Guest
            peer.on('connection', (c) => {
                conn = c;
                statusEl.innerText = "ƒê·ªëi th·ªß ƒë√£ v√†o! Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu!";
                setupEvents();
            });
        }

        function setupEvents() {
            // X√≥a m√†n h√¨nh ch·ªù sau 1 gi√¢y
            setTimeout(() => { document.getElementById('setup-screen').style.display = 'none'; }, 1000);
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');

            conn.on('data', data => {
                if (data.type === 'sync') {
                    enemy.x = data.x; enemy.y = data.y;
                    enemy.bullets = data.bullets;
                    enemy.hp = data.hp; enemy.lives = data.lives;
                }
                if (data.type === 'hit') {
                    me.hp -= 10;
                    if (me.hp <= 0) {
                        me.lives--; me.hp = 100;
                        me.x = Math.random() * 200;
                        if (me.lives <= 0) { alert("B·∫†N ƒê√É THUA CU·ªòC!"); location.reload(); }
                    }
                }
            });
            
            // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game
            gameLoop();
        }

        // --- H√ÄNH ƒê·ªòNG ---
        const joy = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const d = Math.sqrt(dx*dx + dy*dy);
            if (d > 40) { dx *= 40/d; dy *= 40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/7; moveY = dy/7;
        });
        joy.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });

        document.getElementById('btn-dash').addEventListener('touchstart', (e) => {
            e.preventDefault(); me.x += moveX * 15; me.y += moveY * 15;
        });
        document.getElementById('btn-shoot').addEventListener('touchstart', (e) => {
            e.preventDefault(); me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 14 });
        });

        // --- V√íNG L·∫∂P CH√çNH ---
        function gameLoop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            me.x = Math.max(0, Math.min(canvas.width - 40, me.x + moveX));
            me.y = Math.max(0, Math.min(canvas.height - 40, me.y + moveY));

            // ƒê·∫°n bay & Check va ch·∫°m
            me.bullets.forEach((b, i) => {
                b.x += b.vx;
                if (b.x > enemy.x && b.x < enemy.x + 40 && b.y > enemy.y && b.y < enemy.y + 40) {
                    me.bullets.splice(i, 1);
                    if (conn) conn.send({ type: 'hit' });
                }
                if (b.x < 0 || b.x > canvas.width) me.bullets.splice(i, 1);
            });

            // G·ª≠i d·ªØ li·ªáu ƒë·ªìng b·ªô
            if (conn && conn.open) {
                conn.send({
                    type: 'sync',
                    x: canvas.width - me.x - 40,
                    y: me.y,
                    bullets: me.bullets.map(b => ({ x: canvas.width - b.x, y: b.y, vx: -b.vx })),
                    hp: me.hp, lives: me.lives
                });
            }

            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            // S√†n
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            for(let i=0; i<canvas.width; i+=50) { ctx.strokeRect(i, 0, 50, canvas.height); }

            ctx.fillStyle = "#3498db"; ctx.fillRect(me.x, me.y, 40, 40); // Me
            ctx.fillStyle = "#e74c3c"; ctx.fillRect(enemy.x, enemy.y, 40, 40); // Enemy
            
            ctx.font = "24px Arial";
            me.bullets.concat(enemy.bullets).forEach(b => ctx.fillText("üçú", b.x, b.y));

            // Update UI m√°u
            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lives').innerText = me.lives;
            document.getElementById('peer-lives').innerText = enemy.lives;
        }
    </script>
</body>
</html>
