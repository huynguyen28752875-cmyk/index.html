<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Zom-Evo: Ultimate Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; filter: drop-shadow(0 0 5px rgba(34, 211, 238, 0.5)); }
        .ui-panel { position: absolute; inset: 0; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(10px); }
        .btn-cyber { background: linear-gradient(45deg, #06b6d4, #8b5cf6); color: white; padding: 15px 50px; border-radius: 4px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: none; box-shadow: 0 0 20px rgba(6, 182, 212, 0.4); transition: 0.3s; }
        
        /* Mobile Controls */
        #mobile-ctrl { position: absolute; inset: 0; pointer-events: none; display: none; }
        .joy-base { position: absolute; bottom: 50px; left: 60px; width: 130px; height: 130px; background: rgba(255,255,255,0.05); border: 2px solid rgba(34, 211, 238, 0.3); border-radius: 50%; pointer-events: auto; }
        .joy-stick { position: absolute; top: 40px; left: 40px; width: 50px; height: 50px; background: #22d3ee; border-radius: 50%; box-shadow: 0 0 25px #22d3ee; }
        
        .btn-group { position: absolute; bottom: 40px; right: 50px; display: grid; grid-template-areas: "ult dash" "fire fire"; gap: 15px; pointer-events: auto; }
        .btn-circle { width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; border: 2px solid #22d3ee; background: rgba(34, 211, 238, 0.1); text-shadow: 0 0 10px #22d3ee; }
        #btn-fire { grid-area: fire; width: 165px; height: 85px; border-radius: 45px; background: rgba(34, 211, 238, 0.2); font-size: 20px; }
        #btn-dash { grid-area: dash; border-color: #f472b6; color: #f472b6; text-shadow: 0 0 10px #f472b6; }
        #btn-ult { grid-area: ult; border-color: #fbbf24; color: #fbbf24; display: none; }

        #hud { position: absolute; top: 15px; left: 20px; pointer-events: none; z-index: 100; }
        .bar-outer { width: 180px; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.1); }
        #hp-f { height: 100%; background: linear-gradient(90deg, #ef4444, #f87171); width: 100%; transition: 0.2s; box-shadow: 0 0 15px #ef4444; }
        #ult-f { height: 100%; background: linear-gradient(90deg, #eab308, #facc15); width: 0%; box-shadow: 0 0 15px #eab308; }
    </style>
</head>
<body>

    <div id="start-screen" class="ui-panel">
        <h1 class="text-7xl font-black text-cyan-400 mb-2 italic tracking-tighter">ZOM-EVO</h1>
        <p class="text-purple-400 mb-10 tracking-[0.4em] text-xs uppercase">Neon Strike: Mobile Optimized</p>
        <button onclick="initGame()" class="btn-cyber">KHỞI CHẠY HỆ THỐNG</button>
    </div>

    <div id="hud">
        <div class="bar-outer"><div id="hp-f"></div></div>
        <div class="bar-outer"><div id="ult-f"></div></div>
        <div class="text-sm font-bold text-cyan-400 italic">CREDITS: <span id="gold-txt" class="text-white">0</span></div>
    </div>

    <div id="mobile-ctrl">
        <div class="joy-base" id="joystick"><div class="joy-stick" id="stick"></div></div>
        <div class="btn-group">
            <div class="btn-circle" id="btn-ult">ULT</div>
            <div class="btn-circle" id="btn-dash">DASH</div>
            <div class="btn-circle" id="btn-fire">AUTO FIRE</div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let me = { x: 0, y: 0, hp: 100, gold: 0, score: 0, angle: 0, ult: 0, vx: 0, vy: 0, dashing: 0, lastShot: 0 };
        let entities = { zombies: [], bullets: [], particles: [] };
        let joyX = 0, joyY = 0, autoFire = false, audioCtx;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const playBGM = () => {
                let o = audioCtx.createOscillator();
                let g = audioCtx.createGain();
                o.type = 'sawtooth'; o.frequency.setValueAtTime(55, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 2);
                g.gain.setValueAtTime(0.015, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2.5);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); setTimeout(playBGM, 2500);
            };
            playBGM();
        }

        function playSfx(f, t='sine', d=0.1) {
            if(!audioCtx) return;
            let o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.type=t; o.frequency.value = f;
            g.gain.setValueAtTime(0.04, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime+d);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(!me.x) { me.x = canvas.width/2; me.y = canvas.height/2; }
        }
        window.onresize = resize;
        resize();

        function createParticles(x, y, color) {
            for(let i=0; i<8; i++) {
                entities.particles.push({
                    x, y, color,
                    vx: (Math.random()-0.5)*8,
                    vy: (Math.random()-0.5)*8,
                    life: 1.0
                });
            }
        }

        function initGame() {
            initAudio();
            document.getElementById('start-screen').style.display = 'none';
            if(/Android|iPhone/i.test(navigator.userAgent)) document.getElementById('mobile-ctrl').style.display = 'block';
            loop();
        }

        // --- Controls ---
        const joy = document.getElementById('joystick'), st = document.getElementById('stick');
        joy.ontouchmove = (e) => {
            e.preventDefault();
            let t = e.touches[0], r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 65), dy = t.clientY - (r.top + 65);
            let d = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
            let a = Math.atan2(dy, dx);
            joyX = Math.cos(a) * (d/50); joyY = Math.sin(a) * (d/50);
            st.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
        };
        joy.ontouchend = () => { joyX = joyY = 0; st.style.transform = 'none'; };

        document.getElementById('btn-fire').ontouchstart = (e) => { 
            e.preventDefault(); autoFire = !autoFire; 
            e.target.style.background = autoFire ? 'rgba(34, 211, 238, 0.5)' : 'rgba(34, 211, 238, 0.1)';
        };
        document.getElementById('btn-dash').ontouchstart = (e) => { e.preventDefault(); if(me.dashing <= 0) me.dashing = 12; };
        document.getElementById('btn-ult').ontouchstart = (e) => { e.preventDefault(); useUlt(); };

        function useUlt() {
            if(me.ult < 100) return;
            me.ult = 0; playSfx(100, 'square', 0.5);
            entities.zombies.forEach(z => {
                createParticles(z.x, z.y, '#4ade80');
                z.hp = 0;
            });
        }

        function loop() {
            // Movement Fix (Delta-like physics)
            let speed = me.dashing > 0 ? 20 : 7;
            if(me.dashing > 0) me.dashing--;

            me.x += joyX * speed;
            me.y += joyY * speed;
            me.x = Math.max(20, Math.min(canvas.width-20, me.x));
            me.y = Math.max(20, Math.min(canvas.height-20, me.y));

            // Auto-Aim logic
            let nearest = null, minDist = 600;
            entities.zombies.forEach(z => {
                let d = Math.sqrt((z.x-me.x)**2 + (z.y-me.y)**2);
                if(d < minDist) { minDist = d; nearest = z; }
            });
            if(nearest) me.angle = Math.atan2(nearest.y-me.y, nearest.x-me.x);

            // Shooting
            if(autoFire && Date.now() - me.lastShot > 200) {
                entities.bullets.push({ x: me.x, y: me.y, vx: Math.cos(me.angle)*18, vy: Math.sin(me.angle)*18 });
                me.lastShot = Date.now();
                playSfx(800 + Math.random()*200, 'square', 0.04);
            }

            // Entities Update
            if(entities.zombies.length < 12 && Math.random() < 0.04) {
                entities.zombies.push({ x: Math.random()*canvas.width, y: -30, hp: 100, s: 2.5 + Math.random() });
            }

            entities.zombies.forEach((z, i) => {
                let d = Math.sqrt((me.x-z.x)**2+(me.y-z.y)**2);
                z.x += (me.x-z.x)/d * z.s; z.y += (me.y-z.y)/d * z.s;
                if(d < 30) { me.hp -= 0.4; if(Math.random()>0.9) playSfx(150, 'sine', 0.05); }

                entities.bullets.forEach((b, bi) => {
                    if(Math.sqrt((b.x-z.x)**2+(b.y-z.y)**2) < 35) {
                        z.hp -= 50; entities.bullets.splice(bi, 1);
                        if(z.hp <= 0) { 
                            createParticles(z.x, z.y, '#4ade80');
                            entities.zombies.splice(i,1); me.gold += 25; me.ult = Math.min(100, me.ult+8);
                            playSfx(1200, 'sine', 0.05);
                        }
                    }
                });
            });

            entities.bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                if(b.x < -50 || b.x > canvas.width+50 || b.y < -50 || b.y > canvas.height+50) entities.bullets.splice(i, 1);
            });

            entities.particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if(p.life <= 0) entities.particles.splice(i, 1);
            });

            if(me.hp <= 0) location.reload();
            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Grid
            ctx.strokeStyle = 'rgba(34, 211, 238, 0.05)';
            for(let i=0; i<canvas.width; i+=60) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
            for(let i=0; i<canvas.height; i+=60) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

            // Particles
            entities.particles.forEach(p => {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.fillRect(p.x, p.y, 4, 4);
            });
            ctx.globalAlpha = 1.0;

            // Player (Cyber Cat Mech)
            ctx.save(); ctx.translate(me.x, me.y); ctx.rotate(me.angle);
            ctx.shadowBlur = 20; ctx.shadowColor = me.dashing > 0 ? '#f472b6' : '#22d3ee';
            ctx.fillStyle = me.dashing > 0 ? '#f472b6' : '#22d3ee';
            ctx.beginPath(); ctx.roundRect(-22, -22, 44, 44, 8); ctx.fill();
            // Muzzle flash
            if(Date.now() - me.lastShot < 50 && autoFire) {
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(35, 0, 15, 0, 7); ctx.fill();
            }
            ctx.restore();

            // Zombies
            entities.zombies.forEach(z => {
                ctx.fillStyle = '#4ade80'; ctx.shadowBlur = 15; ctx.shadowColor = '#4ade80';
                ctx.beginPath(); ctx.ellipse(z.x, z.y, 22, 26, Math.sin(Date.now()/200), 0, 7); ctx.fill();
            });

            // Bullets
            entities.bullets.forEach(b => {
                ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#facc15';
                ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, 7); ctx.fill();
            });

            document.getElementById('hp-f').style.width = me.hp + '%';
            document.getElementById('ult-f').style.width = me.ult + '%';
            document.getElementById('gold-txt').innerText = me.gold;
            document.getElementById('btn-ult').style.display = me.ult >= 100 ? 'flex' : 'none';
        }

        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                this.beginPath(); this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
                this.closePath(); return this;
            };
        }
    </script>
</body>
</html>
