<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anh Ba ƒê·∫°i Chi·∫øn - Fast Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; background: #2c3e50; }
        .ui-setup { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bar-container { width: 120px; height: 10px; background: #333; border-radius: 5px; border: 1px solid #555; overflow: hidden; }
        .hp-fill { height: 100%; background: #ef4444; transition: width 0.2s; }
        
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 50; border: 2px solid rgba(255,255,255,0.2); }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        
        .btn-action { position: absolute; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; z-index: 50; }
        #btn-shoot { bottom: 40px; right: 40px; width: 85px; height: 85px; background: #e74c3c; border: 4px solid #c0392b; font-size: 14px; }
        #btn-dash { bottom: 140px; right: 50px; width: 60px; height: 60px; background: #3498db; border: 3px solid #2980b9; font-size: 12px; }
    </style>
</head>
<body>

    <div id="setup-screen" class="ui-setup p-6 text-center">
        <h1 class="text-3xl font-black text-yellow-500 mb-6 italic">QU√ÅN PH·ªû ANH BA ONLINE</h1>
        <p class="text-gray-400 mb-4 text-sm">Nh·∫≠p c√πng m·ªôt T√™n Ph√≤ng ƒë·ªÉ ƒë·∫•u v·ªõi b·∫°n b√®</p>
        <input type="text" id="room-input" placeholder="V√≠ d·ª•: anhba123" class="p-3 rounded-lg w-64 text-black font-bold border-none outline-none mb-4">
        <div class="flex gap-4">
            <button onclick="joinRoom()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl font-bold">V√ÄO PH√íNG</button>
        </div>
        <p id="status" class="mt-4 text-xs text-blue-400"></p>
    </div>

    <div class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none z-20">
        <div class="bg-black/60 p-2 rounded-lg">
            <p class="text-[10px] text-blue-400 font-bold">ANH BA (B·∫†N)</p>
            <div class="bar-container"><div id="my-hp" class="hp-fill" style="width: 100%;"></div></div>
            <p class="text-[10px] text-white">M·∫°ng: <span id="my-lives">3</span></p>
        </div>
        <div class="bg-black/60 p-2 rounded-lg text-right">
            <p class="text-[10px] text-red-400 font-bold">ƒê·ªêI TH·ª¶</p>
            <div class="bar-container ml-auto"><div id="peer-hp" class="hp-fill" style="width: 100%;"></div></div>
            <p class="text-[10px] text-white">M·∫°ng: <span id="peer-lives">3</span></p>
        </div>
    </div>

    <div id="joystick"><div id="stick"></div></div>
    <button id="btn-shoot" class="btn-action">N√âM üçú</button>
    <button id="btn-dash" class="btn-action">L∆Ø·ªöT</button>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let peer, conn;

        let me = { x: 100, y: 100, hp: 100, lives: 3, bullets: [], speed: 6 };
        let enemy = { x: -500, y: -500, hp: 100, lives: 3, bullets: [] };
        let moveX = 0, moveY = 0;

        function joinRoom() {
            const roomName = document.getElementById('room-input').value.trim();
            if (!roomName) return alert("H√£y nh·∫≠p t√™n ph√≤ng!");
            
            document.getElementById('status').innerText = "ƒêang k·∫øt n·ªëi...";
            
            // C√°ch ch∆°i d·ªÖ h∆°n: Ng∆∞·ªùi th·ª© 1 l√† Host, ng∆∞·ªùi th·ª© 2 n·ªëi v√†o Host
            peer = new Peer('anh-ba-room-' + roomName); 

            peer.on('open', (id) => {
                document.getElementById('status').innerText = "Ph√≤ng ƒë√£ s·∫µn s√†ng! Ch·ªù b·∫°n b√®...";
                // N·∫øu m√¨nh l√† ng∆∞·ªùi v√†o sau, code s·∫Ω b√°o l·ªói ID ƒë√£ t·ªìn t·∫°i, ta x·ª≠ l√Ω b√™n d∆∞·ªõi
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // ID ƒë√£ c√≥ ng∆∞·ªùi d√πng (Host ƒë√£ ·ªü ƒë√≥), m√¨nh s·∫Ω l√†m Client k·∫øt n·ªëi v√†o
                    peer = new Peer(); // T·∫°o ID ng·∫´u nhi√™n cho m√¨nh
                    setTimeout(() => {
                        conn = peer.connect('anh-ba-room-' + roomName);
                        initConn();
                    }, 500);
                }
            });

            peer.on('connection', (c) => {
                conn = c;
                initConn();
            });
        }

        function initConn() {
            document.getElementById('setup-screen').style.display = 'none';
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy.x = data.x; enemy.y = data.y;
                    enemy.bullets = data.bullets;
                    enemy.hp = data.hp; enemy.lives = data.lives;
                }
                if(data.type === 'damage') {
                    me.hp -= 10;
                    if(me.hp <= 0) {
                        me.lives--;
                        if(me.lives > 0) { me.hp = 100; me.x = Math.random()*200; }
                        else { alert("THUA R·ªíI!"); location.reload(); }
                    }
                }
            });
            gameLoop();
        }

        // Joystick & L∆∞·ªõt
        const joystick = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        joystick.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joystick.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const d = Math.sqrt(dx*dx + dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/10 * me.speed; moveY = dy/10 * me.speed;
        });
        joystick.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });

        document.getElementById('btn-dash').addEventListener('touchstart', () => {
            me.x += moveX * 10; me.y += moveY * 10; // L∆∞·ªõt nhanh g·∫•p 10 l·∫ßn
        });

        document.getElementById('btn-shoot').addEventListener('touchstart', () => {
            me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 12 });
        });

        function gameLoop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            me.x = Math.max(0, Math.min(canvas.width - 40, me.x + moveX));
            me.y = Math.max(0, Math.min(canvas.height - 40, me.y + moveY));

            me.bullets.forEach((b, i) => {
                b.x += b.vx;
                if(b.x > enemy.x && b.x < enemy.x + 40 && b.y > enemy.y && b.y < enemy.y + 40) {
                    me.bullets.splice(i, 1);
                    if(conn) conn.send({ type: 'damage' });
                }
            });

            if(conn && conn.open) {
                conn.send({ type: 'sync', x: canvas.width - me.x - 40, y: me.y, 
                            bullets: me.bullets.map(b => ({...b, x: canvas.width-b.x, vx: -b.vx})),
                            hp: me.hp, lives: me.lives });
            }

            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = "#3498db"; ctx.fillRect(me.x, me.y, 40, 40); // B·∫°n
            ctx.fillStyle = "#e74c3c"; ctx.fillRect(enemy.x, enemy.y, 40, 40); // ƒê·ªãch
            ctx.font = "25px Arial";
            me.bullets.concat(enemy.bullets).forEach(b => ctx.fillText("üçú", b.x, b.y));

            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lives').innerText = me.lives;
            document.getElementById('peer-lives').innerText = enemy.lives;
        }
    </script>
</body>
</html>
