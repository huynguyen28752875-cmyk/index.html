<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Street Fighters VN: Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; }
        canvas { display: block; }
        #lobby { position: absolute; inset: 0; background: radial-gradient(circle, #1e293b, #020617); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .char-btn { border: 4px solid #444; padding: 15px; background: rgba(255,255,255,0.05); transition: 0.3s; width: 180px; text-align: center; }
        .char-btn.active:hover { border-color: #facc15; transform: translateY(-5px); cursor: pointer; }
        .locked { opacity: 0.3; cursor: not-allowed; border-color: #ef4444 !important; }
        .p1-selected { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.2); }
        .p2-selected { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.2); }
        #game-ui { position: absolute; top: 30px; width: 100%; display: none; justify-content: space-around; }
        .hp-outer { width: 40%; height: 35px; background: #222; border: 3px solid #fff; }
        .hp-inner { height: 100%; background: linear-gradient(90deg, #ff0000, #ff6b6b); width: 100%; transition: 0.2s; }
        #fatality { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); z-index: 200; font-size: 120px; color: #ff0000; font-style: italic; text-shadow: 0 0 20px #000; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 id="turn-text" class="text-5xl mb-8 italic text-yellow-400">PLAYER 1: CHỌN VÕ SĨ</h1>
        <div class="flex gap-6">
            <div id="btn-DanChoi" class="char-btn active" onclick="pick('DanChoi')">
                <h2 class="text-2xl font-bold">DÂN CHƠI</h2>
                <p class="text-blue-400 text-xs mt-2">Tốc độ & Nhảy cao</p>
            </div>
            <div id="btn-HiepSi" class="char-btn active" onclick="pick('HiepSi')">
                <h2 class="text-2xl font-bold">HIỆP SĨ</h2>
                <p class="text-red-400 text-xs mt-2">Sức mạnh & Đòn nặng</p>
            </div>
        </div>
        <p class="mt-10 text-gray-400">P1 chọn trước -> Khóa -> P2 chọn</p>
    </div>

    <div id="game-ui">
        <div class="hp-outer"><div id="p1-hp" class="hp-inner"></div></div>
        <div class="hp-outer"><div id="p2-hp" class="hp-inner" style="float:right"></div></div>
    </div>

    <div id="fatality">FATALITY</div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function snd(f, t, d, v=0.1) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
            o.stop(audioCtx.currentTime + d);
        }

        let p1Char = null, p2Char = null;
        let p1, p2, keys = {}, isRunning = false, slowMo = 1, finishHim = false;

        const Config = {
            'DanChoi': { color: '#3b82f6', spd: 9, jump: 23, dmg: 1, hp: 100 },
            'HiepSi': { color: '#ef4444', spd: 5, jump: 17, dmg: 1.8, hp: 120 }
        };

        function pick(type) {
            if (!p1Char) {
                p1Char = type;
                document.getElementById('btn-' + type).classList.add('p1-selected', 'locked');
                document.getElementById('turn-text').innerText = "PLAYER 2: CHỌN VÕ SĨ";
                snd(440, 'sine', 0.2);
            } else if (!p2Char && type !== p1Char) {
                p2Char = type;
                document.getElementById('btn-' + type).classList.add('p2-selected', 'locked');
                snd(660, 'sine', 0.2);
                setTimeout(initMatch, 800);
            }
        }

        function initMatch() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            p1 = new Fighter(300, 1, p1Char);
            p2 = new Fighter(canvas.width - 300, 2, p2Char);
            isRunning = true;
        }

        class Fighter {
            constructor(x, id, type) {
                const c = Config[type];
                this.x = x; this.id = id; this.type = type;
                this.hp = c.hp; this.maxHp = c.hp;
                this.spd = c.spd; this.jump = c.jump; this.dmg = c.dmg;
                this.color = c.color; this.w = 70; this.h = 160;
                this.vy = 0; this.vx = 0; this.isJumping = false;
                this.isAtk = 0; this.atkType = ''; this.dir = id === 1 ? 1 : -1;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.w/2, this.y + this.h/2);
                if(this.dir === -1) ctx.scale(-1, 1);
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 15; ctx.shadowColor = this.color;
                ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
                if(this.isAtk > 0) {
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(30, this.atkType === 'H' || this.atkType === 'J' ? -50 : -10, 100, 40);
                    this.isAtk--;
                }
                ctx.restore();
            }

            update() {
                this.x += this.vx * slowMo;
                this.y += this.vy * slowMo;
                if(this.y + this.h < canvas.height - 80) this.vy += 1;
                else { this.y = canvas.height - 80 - this.h; this.vy = 0; this.isJumping = false; }
            }

            attack(type, key) {
                if(this.isAtk > 0) return;
                this.atkType = type; this.isAtk = 15;
                let enemy = this.id === 1 ? p2 : p1;
                let range = (type === 'H' || type === 'J') ? 180 : 110;
                let d = (type === 'F' || type === 'K') ? 6 : (type === 'G' || type === 'L' ? 12 : 25);
                
                if(Math.abs(this.x - enemy.x) < range && Math.abs(this.y - enemy.y) < 100) {
                    enemy.hp -= d * this.dmg;
                    snd(100, 'square', 0.1);
                    if(enemy.hp <= 0 && !finishHim) {
                        finishHim = true; 
                        snd(50, 'square', 0.5, 0.5);
                    } else if (finishHim && enemy.hp <= 0) {
                        doFatality();
                    }
                } else {
                    snd(300, 'triangle', 0.1);
                }
            }
        }

        function doFatality() {
            slowMo = 0.1;
            document.getElementById('fatality').style.display = 'flex';
            snd(60, 'sawtooth', 2, 0.4);
            setTimeout(() => {
                location.reload(); // Reset Tournament
            }, 3000);
        }

        window.onkeydown = e => {
            keys[e.code] = true;
            if(!isRunning) return;
            // P1: F (Punch), G (Kick), H (Ulti)
            if(e.code === 'KeyF') p1.attack('F');
            if(e.code === 'KeyG') p1.attack('G');
            if(e.code === 'KeyH') p1.attack('H');
            // P2: K (Punch), L (Kick), J (Ulti)
            if(e.code === 'KeyK') p2.attack('K');
            if(e.code === 'KeyL') p2.attack('L');
            if(e.code === 'KeyJ') p2.attack('J');
        };
        window.onkeyup = e => keys[e.code] = false;

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!isRunning) return requestAnimationFrame(loop);

            // P1 Input
            p1.vx = 0;
            if(keys.KeyA) { p1.vx = -p1.spd; p1.dir = -1; }
            if(keys.KeyD) { p1.vx = p1.spd; p1.dir = 1; }
            if(keys.KeyW && !p1.isJumping) { p1.vy = -p1.jump; p1.isJumping = true; }

            // P2 Input
            p2.vx = 0;
            if(keys.ArrowLeft) { p2.vx = -p2.spd; p2.dir = -1; }
            if(keys.ArrowRight) { p2.vx = p2.spd; p2.dir = 1; }
            if(keys.ArrowUp && !p2.isJumping) { p2.vy = -p2.jump; p2.isJumping = true; }

            p1.update(); p2.update();

            // Background
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, canvas.height-80, canvas.width, 80);

            p1.draw(); p2.draw();

            document.getElementById('p1-hp').style.width = Math.max(0, (p1.hp/p1.maxHp)*100) + '%';
            document.getElementById('p2-hp').style.width = Math.max(0, (p2.hp/p2.maxHp)*100) + '%';

            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
