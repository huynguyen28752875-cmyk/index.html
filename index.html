<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zom-Evo: Final Titan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }
        .ui-overlay { position: absolute; inset: 0; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); color: white; }
        .upgrade-card { background: #1e1b4b; border: 2px solid #4338ca; padding: 20px; border-radius: 15px; width: 200px; cursor: pointer; text-align: center; margin: 10px; }
        #hud { position: absolute; top: 15px; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; color: white; }
        .bar-container { width: 120px; height: 10px; background: #222; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        #hp-fill { height: 100%; background: #ef4444; width: 100%; transition: 0.2s; }
        #boss-ui { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 60%; display: none; }
        .boss-bar { width: 100%; height: 20px; background: #111; border: 2px solid #ef4444; border-radius: 10px; overflow: hidden; box-shadow: 0 0 15px #ef4444; }
        #boss-hp-fill { height: 100%; background: #ef4444; width: 100%; }
        #mobile-ctrl { display: none; }
        .m-btn { position: absolute; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        #joystick { bottom: 30px; left: 30px; width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.1); position: absolute; }
        #stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #fff; border-radius: 50%; }
        #btn-shoot { bottom: 30px; right: 30px; width: 80px; height: 80px; background: #ef4444; position: absolute; border: 4px solid #fff; }
    </style>
</head>
<body>

    <div id="start-screen" class="ui-overlay">
        <h1 class="text-6xl font-black text-red-600 mb-2 italic drop-shadow-2xl">FINAL TITAN</h1>
        <button onclick="initGame()" class="bg-red-700 px-16 py-4 rounded-full font-black text-2xl shadow-lg hover:bg-red-600 transition">TIÃŠU DIá»†T TITAN</button>
        <div class="mt-8 text-xs text-gray-400">STAGE 5: TITAN Sáº¼ XUáº¤T HIá»†N</div>
    </div>

    <div id="win-screen" class="ui-overlay hidden">
        <h1 class="text-6xl font-black text-yellow-500 mb-4 italic">CHIáº¾N THáº®NG!</h1>
        <p class="text-2xl mb-8">Báº¡n Ä‘Ã£ giáº£i cá»©u nhÃ¢n loáº¡i.</p>
        <button onclick="location.reload()" class="bg-yellow-600 px-12 py-3 rounded-full font-bold">CHÆ I Láº I</button>
    </div>

    <div id="upgrade-screen" class="ui-overlay hidden">
        <h2 class="text-4xl font-black text-yellow-400 mb-8 italic">EVOLUTION</h2>
        <div class="flex flex-wrap justify-center" id="upgrade-list"></div>
    </div>

    <div id="hud" class="hidden">
        <div>
            <div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold">HP</span><div class="bar-container"><div id="hp-fill"></div></div></div>
            <p class="text-[12px] font-bold">ðŸ’£ <span id="ui-gre">3</span> | ðŸ§± <span id="ui-wall">2</span></p>
        </div>
        <div id="cycle-ui" class="text-center"><div id="cycle-icon" class="text-2xl">ðŸŒž</div><div id="cycle-timer" class="text-xs font-bold">60s</div></div>
        <div class="text-right"><p id="ui-score" class="text-4xl font-black">0</p><p class="text-xs">STAGE <span id="ui-stage">1</span></p></div>
    </div>

    <div id="boss-ui"><p id="boss-name" class="text-center text-red-500 font-bold mb-1 text-xs uppercase tracking-widest">Mega Boss</p><div class="boss-bar"><div id="boss-hp-fill"></div></div></div>
    
    <div id="mobile-ctrl">
        <div id="joystick"><div id="stick"></div></div>
        <button id="btn-shoot" class="m-btn">FIRE</button>
        <button id="btn-grenade" style="bottom:120px; right:30px; width:50px; height:50px; background:#f59e0b" class="m-btn">B</button>
        <button id="btn-wall" style="bottom:120px; right:90px; width:50px; height:50px; background:#10b981" class="m-btn">W</button>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        let me = { x: 500, y: 300, hp: 100, maxHp: 100, stm: 100, score: 0, stage: 1, speed: 4, grenades: 3, walls: 2, angle: 0 };
        let drone = { angle: 0, lastShot: 0, rate: 1500 };
        let entities = { zombies: [], bullets: [], particles: [], walls: [], boss: null, airdrops: [] };
        let screenShake = 0, isNight = false, cycleTime = 60, keys = {}, joyX = 0, joyY = 0, isGameOver = false;

        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('hud').classList.remove('hidden');
            setInterval(() => { if(isGameOver) return; cycleTime--; if(cycleTime<=0){ isNight=!isNight; cycleTime=60; document.getElementById('cycle-icon').innerText=isNight?"ðŸŒ™":"ðŸŒž"; } document.getElementById('cycle-timer').innerText=cycleTime+"s"; }, 1000);
            setInterval(() => { if(!isNight && !isGameOver) entities.airdrops.push({x:Math.random()*(canvas.width-100)+50, y:Math.random()*(canvas.height-100)+50}); }, 25000);
            loop();
        }

        function spawnBoss() {
            let isTitan = me.stage >= 5;
            entities.boss = { 
                x: canvas.width/2, y: -200, 
                hp: isTitan ? 10000 : 2000 * me.stage, 
                maxHp: isTitan ? 10000 : 2000 * me.stage, 
                size: isTitan ? 120 : 80,
                isTitan: isTitan,
                laserActive: false,
                lastSkill: Date.now()
            };
            document.getElementById('boss-ui').style.display = 'block';
            document.getElementById('boss-name').innerText = isTitan ? "âš ï¸ FINAL TITAN âš ï¸" : "MEGA BOSS";
        }

        function loop() {
            if(isGameOver) return;
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!document.getElementById('upgrade-screen').classList.contains('hidden')) { requestAnimationFrame(loop); return; }

            // Movement Logic
            let s = (keys['ShiftLeft'] && me.stm > 0) ? me.speed*1.8 : me.speed;
            if(keys['ShiftLeft'] && me.stm > 0) me.stm -= 1; else if(me.stm < 100) me.stm += 0.4;
            if(/Android|iPhone/i.test(navigator.userAgent)) { me.x += joyX*s; me.y += joyY*s; if(Math.abs(joyX)>0.1) me.angle = Math.atan2(joyY, joyX); }
            else { if(keys['KeyW']) me.y -= s; if(keys['KeyS']) me.y += s; if(keys['KeyA']) me.x -= s; if(keys['KeyD']) me.x += s; }

            // Drone
            drone.angle += 0.05;
            let dX = me.x + 20 + Math.cos(drone.angle)*50, dY = me.y + 20 + Math.sin(drone.angle)*50;
            if(Date.now() - drone.lastShot > drone.rate && entities.zombies.length > 0) {
                let t = entities.zombies[0];
                let a = Math.atan2(t.y-dY, t.x-dX);
                entities.bullets.push({x:dX, y:dY, vx:Math.cos(a)*12, vy:Math.sin(a)*12, color:'#22d3ee'});
                drone.lastShot = Date.now();
            }

            // Boss & Titan Logic
            if(entities.boss) {
                let b = entities.boss;
                let d = Math.sqrt((me.x-b.x)**2+(me.y-b.y)**2);
                b.x += (me.x-b.x)/d * (b.isTitan ? 1 : 1.5);
                b.y += (me.y-b.y)/d * (b.isTitan ? 1 : 1.5);
                if(d < b.size) me.hp -= 1;

                if(b.isTitan && Date.now() - b.lastSkill > 4000) {
                    if(Math.random() > 0.5) { // Skill: Summon
                        for(let i=0; i<5; i++) entities.zombies.push({x:b.x+(Math.random()-0.5)*200, y:b.y+(Math.random()-0.5)*200, hp:200});
                    } else { // Skill: Laser
                        b.laserActive = true; setTimeout(() => b.laserActive = false, 1500);
                        screenShake = 10;
                    }
                    b.lastSkill = Date.now();
                }
                if(b.laserActive) {
                    let laserAng = Math.atan2(me.y-b.y, me.x-b.x);
                    if(Math.abs(laserAng - Math.atan2(me.y-b.y, me.x-b.x)) < 0.2) me.hp -= 2;
                }
            } else if(Math.random() < (isNight ? 0.08 : 0.04)) {
                entities.zombies.push({ x: Math.random()*canvas.width, y: -50, hp: isNight?200:80 });
            }

            // Collisions
            entities.bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                entities.zombies.forEach((z, zi) => {
                    if(Math.sqrt((b.x-z.x)**2+(b.y-z.y)**2) < 25) { z.hp -= 50; entities.bullets.splice(i, 1); if(z.hp<=0){entities.zombies.splice(zi, 1); me.score += 100;} }
                });
                if(entities.boss && Math.sqrt((b.x-entities.boss.x)**2+(b.y-entities.boss.y)**2) < entities.boss.size) {
                    entities.boss.hp -= 40; entities.bullets.splice(i, 1);
                    if(entities.boss.hp <= 0) { 
                        if(entities.boss.isTitan) { isGameOver = true; document.getElementById('win-screen').classList.remove('hidden'); }
                        entities.boss = null; me.stage++; document.getElementById('boss-ui').style.display='none';
                    }
                }
            });

            if(me.score > 0 && me.score % 1000 === 0) { me.score+=10; showUpgrades(); }
            if(me.hp <= 0) location.reload();

            draw(dX, dY);
            requestAnimationFrame(loop);
        }

        function draw(dX, dY) {
            ctx.save();
            if(screenShake > 0) { ctx.translate(Math.random()*screenShake-screenShake/2, Math.random()*screenShake-screenShake/2); screenShake *= 0.9; }
            ctx.fillStyle = isNight ? '#020205' : '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);

            if(entities.boss) {
                let b = entities.boss;
                ctx.fillStyle = b.isTitan ? '#7f1d1d' : '#7e22ce';
                ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, 7); ctx.fill();
                if(b.laserActive) { ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 20; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(me.x, me.y); ctx.stroke(); }
                document.getElementById('boss-hp-fill').style.width = (b.hp/b.maxHp)*100 + '%';
            }

            ctx.fillStyle = isNight ? '#ef4444' : '#16a34a'; 
            entities.zombies.forEach(z => { ctx.beginPath(); ctx.arc(z.x, z.y, 20, 0, 7); ctx.fill(); });
            
            ctx.fillStyle = '#22d3ee'; ctx.fillRect(dX-8, dY-8, 16, 16);
            ctx.fillStyle = '#4f46e5'; ctx.save(); ctx.translate(me.x+20, me.y+20); ctx.rotate(me.angle); ctx.fillRect(-20,-20,40,40); ctx.restore();

            entities.bullets.forEach(b => { ctx.fillStyle=b.color||'#fbbf24'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, 7); ctx.fill(); });
            entities.particles.forEach((p, i) => { ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); p.life-=0.02; });
            
            ctx.restore();
            document.getElementById('hp-fill').style.width = (me.hp/me.maxHp)*100 + '%';
            document.getElementById('ui-score').innerText = me.score;
            document.getElementById('ui-stage').innerText = me.stage;
        }

        function showUpgrades() {
            const list = document.getElementById('upgrade-list'); list.innerHTML = '';
            const opts = [{t:"â¤ï¸ HP", f:()=>me.maxHp+=100}, {t:"ðŸ¤– DRONE SPEED", f:()=>drone.rate-=300}, {t:"âš¡ SPEED", f:()=>me.speed+=1}];
            opts.forEach(o => {
                let d = document.createElement('div'); d.className='upgrade-card'; d.innerHTML=`<b>${o.t}</b>`;
                d.onclick=()=>{ o.f(); me.hp=me.maxHp; document.getElementById('upgrade-screen').classList.add('hidden'); spawnBoss(); };
                list.appendChild(d);
            });
            document.getElementById('upgrade-screen').classList.remove('hidden');
        }

        window.onkeydown = e => { keys[e.code] = true; };
        window.onkeyup = e => keys[e.code] = false;
        window.onmousemove = e => { me.angle = Math.atan2(e.clientY-(me.y+20), e.clientX-(me.x+20)); };
        window.onmousedown = () => { entities.bullets.push({x:me.x+20, y:me.y+20, vx:Math.cos(me.angle)*16, vy:Math.sin(me.angle)*16}); };

        // Mobile Handlers
        const joy = document.getElementById('joystick'), st = document.getElementById('stick');
        joy.ontouchmove = e => {
            let t = e.touches[0], r = joy.getBoundingClientRect();
            let dx = t.clientX-(r.left+50), dy = t.clientY-(r.top+50);
            let d = Math.sqrt(dx*dx+dy*dy); if(d>40){dx*=40/d;dy*=40/d;}
            st.style.transform = `translate(${dx}px, ${dy}px)`; joyX = dx/40; joyY = dy/40;
        };
        joy.ontouchend = () => { joyX=0; joyY=0; st.style.transform='none'; };
        document.getElementById('btn-shoot').ontouchstart = e => { e.preventDefault(); entities.bullets.push({x:me.x+20, y:me.y+20, vx:Math.cos(me.angle)*16, vy:Math.sin(me.angle)*16}); };
    </script>
</body>
</html>
