<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zombie Outbreak: Evolution</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        canvas { display: block; background: #1a1a1a; }
        .ui-setup { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .game-hud { position: absolute; top: 10px; width: 100%; padding: 0 20px; pointer-events: none; z-index: 50; display: flex; justify-content: space-between; }
        .bar { width: 100px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #555; }
        .hp-fill { height: 100%; background: #22c55e; transition: width 0.3s; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #444; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        #btn-shoot { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: #ef4444; border-radius: 50%; color: white; font-weight: bold; border: 4px solid #b91c1c; }
    </style>
</head>
<body>

    <div id="setup-screen" class="ui-setup">
        <h1 class="text-4xl font-black text-red-600 mb-6 italic underline">ZOMBIE EVOLUTION</h1>
        <input type="text" id="name-in" class="p-4 rounded-xl w-72 text-black font-bold mb-4 outline-none border-4 border-red-500" placeholder="Tên nhân vật">
        <input type="text" id="room-in" class="p-4 rounded-xl w-72 text-black font-bold mb-6 outline-none border-4 border-blue-500" placeholder="Mã phòng bí mật">
        <button onclick="initSurvivor()" class="bg-red-600 px-12 py-4 rounded-2xl font-black text-xl hover:scale-105 transition">VÀO SINH TỒN</button>
        <p id="status" class="mt-4 text-gray-400 text-sm italic"></p>
    </div>

    <div id="game-ui" class="game-hud hidden">
        <div class="bg-black/70 p-3 rounded-xl border border-blue-500">
            <p id="my-name" class="text-blue-400 font-bold text-xs">---</p>
            <div class="bar"><div id="my-hp" class="hp-fill"></div></div>
            <p class="text-[10px] text-white">LV: <span id="my-lv" class="text-yellow-400">1</span> | SCORE: <span id="my-score">0</span></p>
        </div>
        <div class="bg-black/70 p-3 rounded-xl border border-red-500 text-right">
            <p id="peer-name" class="text-red-400 font-bold text-xs">ĐANG CHỜ...</p>
            <div class="bar ml-auto"><div id="peer-hp" class="hp-fill"></div></div>
            <p class="text-[10px] text-white">LV: <span id="peer-lv">1</span> | SCORE: <span id="peer-score">0</span></p>
        </div>
    </div>

    <div id="ctrl" class="hidden">
        <div id="joystick"><div id="stick"></div></div>
        <button id="btn-shoot">BẮN</button>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let peer, conn, roomName;

        let me = { x: 200, y: 200, hp: 100, lv: 1, score: 0, kills: 0, bullets: [], isDead: false };
        let enemy = { x: -1000, y: -1000, hp: 100, lv: 1, score: 0, bullets: [] };
        let zombies = [];
        let moveX = 0, moveY = 0;

        function initSurvivor() {
            const name = document.getElementById('name-in').value.trim();
            const room = document.getElementById('room-in').value.trim();
            if(!name || !room) return alert("Nhập tên và phòng!");

            // Thiết lập mới hoàn toàn khi đổi tên/phòng
            me.score = 0; me.lv = 1; me.kills = 0;
            roomName = 'zombie-p2p-' + room.toLowerCase();
            document.getElementById('my-name').innerText = name.toUpperCase();
            document.getElementById('status').innerText = "Đang tìm tín hiệu đồng đội...";

            peer = new Peer(roomName);
            peer.on('open', () => document.getElementById('status').innerText = "Đang chờ đồng đội vào cùng phòng...");
            peer.on('connection', (c) => { conn = c; setupGame(); });
            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    peer = new Peer();
                    setTimeout(() => { conn = peer.connect(roomName); setupGame(); }, 500);
                }
            });
        }

        function setupGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('ctrl').classList.remove('hidden');
            
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy = { ...enemy, ...data.player };
                    document.getElementById('peer-name').innerText = data.name;
                    if(data.isHost) zombies = data.zombies; // Chỉ nhận zombie từ Host
                }
                if(data.type === 'hit-zombie') {
                    let z = zombies.find(z => z.id === data.id);
                    if(z) {
                        z.hp -= 20;
                        if(z.hp <= 0) {
                            zombies = zombies.filter(item => item.id !== z.id);
                            // Đồng đội giết thì mình cũng thấy họ được điểm
                        }
                    }
                }
            });
            loop();
        }

        // --- GAME LOGIC ---
        function shoot() {
            if(me.isDead) return;
            me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 10 });
        }

        function levelUp() {
            me.lv++;
            me.hp = 100; // Hồi máu
            me.score += 500; // Thưởng điểm
            console.log("LEVEL UP!");
        }

        function die() {
            me.isDead = true;
            me.hp = 0;
            setTimeout(() => {
                me.isDead = false;
                me.hp = 100;
                me.x = Math.random() * canvas.width;
                me.y = Math.random() * canvas.height;
            }, 3000); // Hồi sinh sau 3 giây
        }

        // --- CONTROLS ---
        const joy = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const d = Math.sqrt(dx*dx + dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/8; moveY = dy/8;
        });
        joy.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });
        document.getElementById('btn-shoot').onclick = shoot;

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!me.isDead) {
                me.x = Math.max(0, Math.min(canvas.width - 40, me.x + moveX));
                me.y = Math.max(0, Math.min(canvas.height - 40, me.y + moveY));
            }

            // Host sinh Zombie
            if(!peer.id.includes('aba') && zombies.length < 5 && Math.random() < 0.02) {
                zombies.push({ id: Date.now(), x: Math.random()*canvas.width, y: -50, hp: 60 });
            }

            // Zombie đuổi người
            zombies.forEach(z => {
                let target = me.isDead ? enemy : me;
                let dx = target.x - z.x, dy = target.y - z.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                z.x += dx/dist * 1.5; z.y += dy/dist * 1.5;

                // Zombie cắn mình
                if(dist < 30 && !me.isDead) {
                    me.hp -= 0.5;
                    if(me.hp <= 0) die();
                }
            });

            // Xử lý đạn
            me.bullets.forEach((b, bi) => {
                b.x += b.vx;
                zombies.forEach((z, zi) => {
                    let dx = b.x - z.x, dy = b.y - z.y;
                    if(Math.sqrt(dx*dx + dy*dy) < 30) {
                        me.bullets.splice(bi, 1);
                        z.hp -= 20;
                        if(conn) conn.send({ type: 'hit-zombie', id: z.id });
                        if(z.hp <= 0) {
                            zombies.splice(zi, 1);
                            me.score += 100; me.kills++;
                            if(me.kills % 3 === 0) levelUp();
                        }
                    }
                });
            });

            // Đồng bộ
            if(conn && conn.open) {
                conn.send({
                    type: 'sync',
                    name: document.getElementById('name-in').value,
                    player: { x: canvas.width - me.x - 40, y: me.y, hp: me.hp, lv: me.lv, score: me.score },
                    zombies: zombies.map(z => ({ ...z, x: canvas.width - z.x, y: z.y })),
                    isHost: !peer.id.includes('aba')
                });
            }

            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            
            // Vẽ mình (Người trưởng thành - Blue)
            if(!me.isDead) {
                ctx.fillStyle = "#3498db"; ctx.fillRect(me.x, me.y, 40, 40);
                ctx.fillStyle = "white"; ctx.fillText("BẠN", me.x, me.y-5);
            } else {
                ctx.fillStyle = "gray"; ctx.fillText("ĐANG HỒI SINH...", me.x, me.y);
            }

            // Vẽ đồng đội (Red)
            ctx.fillStyle = "#e74c3c"; ctx.fillRect(enemy.x, enemy.y, 40, 40);

            // Vẽ Zombie (Green)
            zombies.forEach(z => {
                ctx.fillStyle = "#2ecc71";
                ctx.beginPath(); ctx.arc(z.x, z.y, 20, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "red"; ctx.fillRect(z.x-15, z.y-25, z.hp/2, 4);
            });

            // Vẽ đạn
            ctx.fillStyle = "yellow";
            me.bullets.forEach(b => ctx.fillRect(b.x, b.y, 10, 4));

            // Cập nhật UI
            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lv').innerText = me.lv;
            document.getElementById('my-score').innerText = me.score;
            document.getElementById('peer-lv').innerText = enemy.lv;
            document.getElementById('peer-score').innerText = enemy.score;
        }
    </script>
</body>
</html>
