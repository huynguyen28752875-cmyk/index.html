<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anh Ba Online - Fixed Connection</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; background: #2c3e50; }
        .ui-setup { position: absolute; inset: 0; background: #111; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hp-bar { width: 120px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #666; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid white; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; }
        .btn { position: absolute; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        #btn-shoot { bottom: 40px; right: 40px; width: 80px; height: 80px; background: #e74c3c; border: 4px solid #c0392b; }
        #btn-dash { bottom: 130px; right: 50px; width: 60px; height: 60px; background: #3498db; border: 3px solid #2980b9; }
    </style>
</head>
<body>

    <div id="setup-screen" class="ui-setup">
        <h1 class="text-3xl font-black text-yellow-500 mb-2 italic">QU√ÅN PH·ªû ANH BA</h1>
        <p class="text-white text-sm mb-6">Nh·∫≠p t√™n ph√≤ng gi·ªëng b·∫°n b√® (Vd: phong123)</p>
        <input type="text" id="room-input" class="p-3 rounded-lg w-64 text-black font-bold mb-4 outline-none" placeholder="T√™n ph√≤ng...">
        <button onclick="startConnection()" class="bg-green-600 text-white px-10 py-3 rounded-xl font-bold text-lg active:scale-95 transition">V√ÄO CHI·∫æN</button>
        <p id="status" class="mt-4 text-blue-400 font-bold text-sm"></p>
    </div>

    <div class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none z-50">
        <div class="bg-black/60 p-2 rounded">
            <p class="text-[10px] text-blue-400 font-bold">B·∫†N</p>
            <div class="hp-bar"><div id="my-hp" style="width: 100%; height: 100%; background: #4ade80;"></div></div>
            <p class="text-white text-[10px]">M·∫°ng: <span id="my-lives">3</span></p>
        </div>
        <div class="bg-black/60 p-2 rounded text-right">
            <p class="text-[10px] text-red-400 font-bold">ƒê·ªêI TH·ª¶</p>
            <div class="hp-bar ml-auto"><div id="peer-hp" style="width: 100%; height: 100%; background: #ef4444;"></div></div>
            <p class="text-white text-[10px]">M·∫°ng: <span id="peer-lives">3</span></p>
        </div>
    </div>

    <div id="joystick"><div id="stick"></div></div>
    <button id="btn-shoot" class="btn">N√âM üçú</button>
    <button id="btn-dash" class="btn">L∆Ø·ªöT</button>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let peer, conn, roomID;

        let me = { x: 100, y: 100, hp: 100, lives: 3, bullets: [] };
        let enemy = { x: -1000, y: -1000, hp: 100, lives: 3, bullets: [] };
        let moveX = 0, moveY = 0;

        function startConnection() {
            const input = document.getElementById('room-input').value.trim();
            if (!input) return alert("Nh·∫≠p t√™n ph√≤ng ƒë√£!");
            roomID = 'anhba-room-' + input;
            document.getElementById('status').innerText = "ƒêang ki·ªÉm tra ph√≤ng...";

            peer = new Peer(roomID);

            peer.on('open', () => {
                document.getElementById('status').innerText = "B·∫°n l√† CH·ª¶ PH√íNG. Ch·ªù b·∫°n b√® nh·∫≠p c√πng t√™n...";
            });

            peer.on('connection', (c) => {
                conn = c;
                setupDataExchange();
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // N·∫øu ID ƒë√£ c√≥ ng∆∞·ªùi d√πng, ta l√†m Kh√°ch
                    peer = new Peer(); 
                    setTimeout(() => {
                        conn = peer.connect(roomID);
                        setupDataExchange();
                    }, 500);
                }
            });
        }

        function setupDataExchange() {
            document.getElementById('setup-screen').style.display = 'none';
            conn.on('open', () => {
                setInterval(sendData, 30); // G·ª≠i d·ªØ li·ªáu li√™n t·ª•c 30 l·∫ßn/gi√¢y
            });
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy.x = data.x; enemy.y = data.y;
                    enemy.bullets = data.bullets;
                    enemy.hp = data.hp; enemy.lives = data.lives;
                }
                if(data.type === 'hit') {
                    me.hp -= 10;
                    if(me.hp <= 0) {
                        me.lives--; me.hp = 100;
                        me.x = Math.random()*200;
                        if(me.lives <= 0) { alert("B·∫†N THUA!"); location.reload(); }
                    }
                }
            });
            gameLoop();
        }

        function sendData() {
            if(conn && conn.open) {
                conn.send({
                    type: 'sync',
                    x: canvas.width - me.x - 40, // Mirror v·ªã tr√≠
                    y: me.y,
                    bullets: me.bullets.map(b => ({ x: canvas.width - b.x, y: b.y, vx: -b.vx })),
                    hp: me.hp, lives: me.lives
                });
            }
        }

        // Joystick & Gameplay
        const joy = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 40) { dx *= 40/dist; dy *= 40/dist; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveX = dx/8; moveY = dy/8;
        });
        joy.addEventListener('touchend', () => { moveX = 0; moveY = 0; stick.style.transform = 'none'; });

        document.getElementById('btn-dash').addEventListener('touchstart', () => { me.x += moveX * 12; me.y += moveY * 12; });
        document.getElementById('btn-shoot').addEventListener('touchstart', () => { me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 12 }); });

        function gameLoop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            me.x = Math.max(0, Math.min(canvas.width - 40, me.x + moveX));
            me.y = Math.max(0, Math.min(canvas.height - 40, me.y + moveY));

            me.bullets.forEach((b, i) => {
                b.x += b.vx;
                if(b.x > enemy.x && b.x < enemy.x + 40 && b.y > enemy.y && b.y < enemy.y + 40) {
                    me.bullets.splice(i, 1);
                    if(conn) conn.send({ type: 'hit' });
                }
                if(b.x < 0 || b.x > canvas.width) me.bullets.splice(i, 1);
            });

            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = "#3498db"; ctx.fillRect(me.x, me.y, 40, 40); // Me
            ctx.fillStyle = "#e74c3c"; ctx.fillRect(enemy.x, enemy.y, 40, 40); // Enemy
            ctx.font = "20px Arial";
            me.bullets.concat(enemy.bullets).forEach(b => ctx.fillText("üçú", b.x, b.y));

            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lives').innerText = me.lives;
            document.getElementById('peer-lives').innerText = enemy.lives;
        }
    </script>
</body>
</html>
