<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Fighters VN: Fatality</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 10; }
        .bar-container { width: 40%; }
        .hp-outer { height: 30px; background: #222; border: 3px solid #fff; border-radius: 4px; overflow: hidden; }
        .hp-inner { height: 100%; background: linear-gradient(90deg, #f87171, #ef4444); width: 100%; transition: 0.1s; }
        .mana-outer { height: 10px; background: #111; margin-top: 5px; border-radius: 2px; }
        .mana-inner { height: 100%; background: #22d3ee; width: 0%; transition: 0.3s; }
        #fatality-screen { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 50; }
        #fatality-text { font-size: 120px; font-weight: 900; color: #ff0000; font-style: italic; text-shadow: 0 0 30px #f00; animation: stomp 0.5s ease-out; }
        @keyframes stomp { 0% { transform: scale(5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="ui">
        <div class="bar-container">
            <div class="text-white font-bold italic mb-1">DÂN CHƠI</div>
            <div class="hp-outer"><div id="p1-hp" class="hp-inner"></div></div>
            <div class="mana-outer"><div id="p1-mana" class="mana-inner"></div></div>
        </div>
        <div class="bar-container text-right">
            <div class="text-white font-bold italic mb-1">HIỆP SĨ</div>
            <div class="hp-outer"><div id="p2-hp" class="hp-inner" style="float:right"></div></div>
            <div class="mana-outer" style="float:right; width:80%"><div id="p2-mana" class="mana-inner"></div></div>
        </div>
    </div>

    <div id="fatality-screen"><h1 id="fatality-text">FATALITY</h1></div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function snd(f, t, d, v=0.1) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
            o.stop(audioCtx.currentTime + d);
        }

        let shake = 0, isFatality = false, gameSpeed = 1;

        class Player {
            constructor(x, color, id, stats) {
                this.id = id; this.x = x; this.y = 0; this.w = 70; this.h = 150;
                this.color = color; this.vx = 0; this.vy = 0; this.hp = 100; this.mana = 0;
                this.isJumping = false; this.isAttacking = 0; this.dir = id === 1 ? 1 : -1;
                this.stats = stats; // {spd, dmg, jump}
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.w/2, this.y + this.h/2);
                if(this.dir === -1) ctx.scale(-1, 1);

                // Bóng đổ
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath(); ctx.ellipse(0, this.h/2 + 20, 40, 10, 0, 0, 7); ctx.fill();

                // Thân
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 20; ctx.shadowColor = this.color;
                ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
                
                // Hiệu ứng tấn công
                if(this.isAttacking > 0) {
                    ctx.fillStyle = "#fff";
                    ctx.shadowColor = "#fff";
                    if(this.atkType === 'P') ctx.fillRect(30, -20, 60, 20);
                    if(this.atkType === 'K') ctx.fillRect(20, 30, 80, 25);
                    if(this.atkType === 'U') {
                        ctx.fillStyle = "#fbbf24"; ctx.shadowColor = "#fbbf24";
                        ctx.fillRect(30, -50, 250, 100);
                    }
                    this.isAttacking -= gameSpeed;
                }
                ctx.restore();
            }

            update() {
                this.x += this.vx * gameSpeed;
                this.y += this.vy * gameSpeed;
                if(this.y + this.h < canvas.height - 100) this.vy += 1;
                else { this.y = canvas.height - 100 - this.h; this.vy = 0; this.isJumping = false; }
                this.mana = Math.min(100, this.mana + 0.1 * gameSpeed);
            }

            attack(type) {
                if(this.isAttacking > 0 || isFatality) return;
                this.atkType = type;
                this.isAttacking = 20;
                let range = type === 'P' ? 100 : (type === 'K' ? 130 : 300);
                let damage = (type === 'P' ? 5 : (type === 'K' ? 10 : 30)) * this.stats.dmg;
                
                if(type === 'U') { this.mana = 0; snd(100, 'sawtooth', 1, 0.3); }
                else snd(200, 'square', 0.1);

                let enemy = this.id === 1 ? p2 : p1;
                let dist = Math.abs((this.x + this.w/2) - (enemy.x + enemy.w/2));
                
                if(dist < range && enemy.y + enemy.h > this.y && enemy.y < this.y + this.h) {
                    enemy.hp -= damage;
                    enemy.vx = this.dir * 20;
                    shake = 15;
                    snd(150, 'sine', 0.2, 0.3);
                    if(enemy.hp <= 0) triggerFatality();
                }
            }
        }

        const p1 = new Player(200, "#f87171", 1, {spd: 8, dmg: 1, jump: 22});
        const p2 = new Player(800, "#60a5fa", 2, {spd: 5, dmg: 1.5, jump: 18});
        const keys = {};

        window.onkeydown = e => {
            keys[e.code] = true;
            if(e.code === 'KeyF') p1.attack('P');
            if(e.code === 'KeyG') p1.attack('K');
            if(e.code === 'KeyH' && p1.mana >= 100) p1.attack('U');
            if(e.code === 'KeyK') p2.attack('P');
            if(e.code === 'KeyL') p2.attack('K');
            if(e.code === 'KeyJ' && p2.mana >= 100) p2.attack('U');
        };
        window.onkeyup = e => keys[e.code] = false;

        function triggerFatality() {
            isFatality = true;
            gameSpeed = 0.1; // Slow motion
            document.getElementById('fatality-screen').style.display = 'flex';
            snd(40, 'square', 2, 0.5);
            setTimeout(() => { gameSpeed = 0; }, 2000);
        }

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(shake > 0) { ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2); shake--; }

            // BG
            let g = ctx.createLinearGradient(0,0,0,canvas.height);
            g.addColorStop(0, isFatality ? '#222' : '#0f172a');
            g.addColorStop(1, isFatality ? '#000' : '#1e1b4b');
            ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);

            // Ground
            ctx.fillStyle = '#334155'; ctx.fillRect(0, canvas.height-100, canvas.width, 100);

            // P1 Input
            p1.vx = 0;
            if(keys.KeyA) { p1.vx = -p1.stats.spd; p1.dir = -1; }
            if(keys.KeyD) { p1.vx = p1.stats.spd; p1.dir = 1; }
            if(keys.KeyW && !p1.isJumping) { p1.vy = -p1.stats.jump; p1.isJumping = true; }

            // P2 Input
            p2.vx = 0;
            if(keys.ArrowLeft) { p2.vx = -p2.stats.spd; p2.dir = -1; }
            if(keys.ArrowRight) { p2.vx = p2.stats.spd; p2.dir = 1; }
            if(keys.ArrowUp && !p2.isJumping) { p2.vy = -p2.stats.jump; p2.isJumping = true; }

            p1.update(); p2.update();
            p1.draw(); p2.draw();

            document.getElementById('p1-hp').style.width = Math.max(0, p1.hp) + '%';
            document.getElementById('p2-hp').style.width = Math.max(0, p2.hp) + '%';
            document.getElementById('p1-mana').style.width = p1.mana + '%';
            document.getElementById('p2-mana').style.width = p2.mana + '%';

            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
