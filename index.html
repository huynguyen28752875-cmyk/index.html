<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zombie Evolution - PC & Mobile</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; color: white; }
        canvas { display: block; background: radial-gradient(circle, #2c3e50 0%, #000 100%); }
        .ui-setup { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .game-hud { position: absolute; top: 10px; width: 100%; padding: 0 20px; pointer-events: none; z-index: 50; display: flex; justify-content: space-between; }
        .bar { width: 120px; height: 12px; background: #333; border-radius: 6px; overflow: hidden; border: 1px solid #555; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); transition: width 0.3s; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #444; display: none; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        #btn-shoot { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: #ef4444; border-radius: 50%; border: 4px solid #b91c1c; display: none; }
        .pc-hint { position: absolute; bottom: 10px; width: 100%; text-align: center; color: #666; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="setup-screen" class="ui-setup">
        <h1 class="text-5xl font-black text-red-600 mb-2 italic tracking-tighter">ZOMBIE EVOLUTION</h1>
        <p class="mb-8 text-gray-500 tracking-widest uppercase text-xs">Phím: WASD để đi - Space để bắn</p>
        <input type="text" id="name-in" class="p-4 rounded-xl w-72 text-black font-bold mb-4 outline-none border-4 border-red-600" placeholder="Tên của bạn">
        <input type="text" id="room-in" class="p-4 rounded-xl w-72 text-black font-bold mb-6 outline-none border-4 border-blue-600" placeholder="Tên phòng (Ví dụ: phuong123)">
        <button onclick="initSurvivor()" class="bg-red-600 px-12 py-4 rounded-2xl font-black text-xl hover:bg-red-500 transition-all shadow-2xl">VÀO TRẬN CHIẾN</button>
        <p id="status" class="mt-4 text-blue-400 text-sm italic"></p>
    </div>

    <div id="game-ui" class="game-hud hidden">
        <div class="bg-black/80 p-3 rounded-xl border-l-4 border-blue-500">
            <p id="my-name-ui" class="text-blue-400 font-bold text-xs">---</p>
            <div class="bar"><div id="my-hp" class="hp-fill" style="width: 100%"></div></div>
            <p class="text-[10px] mt-1">LV: <span id="my-lv" class="text-yellow-400">1</span> | ĐIỂM: <span id="my-score">0</span></p>
        </div>
        <div class="bg-black/80 p-3 rounded-xl border-r-4 border-red-500 text-right">
            <p id="peer-name-ui" class="text-red-400 font-bold text-xs">CHỜ ĐỒNG ĐỘI...</p>
            <div class="bar ml-auto"><div id="peer-hp" class="hp-fill" style="width: 100%"></div></div>
            <p class="text-[10px] mt-1">LV: <span id="peer-lv">1</span> | ĐIỂM: <span id="peer-score">0</span></p>
        </div>
    </div>

    <div id="mobile-ctrl">
        <div id="joystick"><div id="stick"></div></div>
        <button id="btn-shoot">BẮN</button>
    </div>

    <div class="pc-hint">PC: WASD / Mũi tên để di chuyển | Space để tấn công</div>
    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let peer, conn, roomName;

        let me = { x: 300, y: 300, hp: 100, lv: 1, score: 0, kills: 0, bullets: [], isDead: false, speed: 5 };
        let enemy = { x: -2000, y: -2000, hp: 100, lv: 1, score: 0, bullets: [] };
        let zombies = [];
        let keys = {};

        // Phát hiện thiết bị di động
        if ('ontouchstart' in window) {
            document.getElementById('joystick').style.display = 'block';
            document.getElementById('btn-shoot').style.display = 'block';
        }

        function initSurvivor() {
            const name = document.getElementById('name-in').value.trim();
            const room = document.getElementById('room-in').value.trim();
            if(!name || !room) return alert("Vui lòng nhập đầy đủ!");

            // Reset dữ liệu trận mới
            me.score = 0; me.lv = 1; me.kills = 0;
            roomName = 'zombie-evolution-' + room.toLowerCase();
            document.getElementById('my-name-ui').innerText = name.toUpperCase();
            document.getElementById('status').innerText = "Đang kết nối vệ tinh...";

            peer = new Peer(roomName);
            peer.on('open', () => document.getElementById('status').innerText = "Đã mở phòng. Hãy bảo bạn bè nhập đúng tên phòng này!");
            peer.on('connection', (c) => { conn = c; setupGame(); });
            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    peer = new Peer();
                    setTimeout(() => { conn = peer.connect(roomName); setupGame(); }, 500);
                }
            });
        }

        function setupGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            
            conn.on('data', data => {
                if(data.type === 'sync') {
                    enemy = { ...enemy, ...data.player };
                    document.getElementById('peer-name-ui').innerText = data.name.toUpperCase();
                    if(data.isHost) zombies = data.zombies;
                }
                if(data.type === 'hit-zombie') {
                    let z = zombies.find(z => z.id === data.id);
                    if(z) {
                        z.hp -= 20;
                        if(z.hp <= 0) zombies = zombies.filter(item => item.id !== z.id);
                    }
                }
            });
            loop();
        }

        // --- XỬ LÝ BÀN PHÍM ---
        window.addEventListener('keydown', e => { 
            keys[e.code] = true; 
            if(e.code === 'Space') shoot();
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function shoot() {
            if(me.isDead) return;
            me.bullets.push({ x: me.x + 20, y: me.y + 20, vx: 12 });
        }

        function levelUp() {
            me.lv++;
            me.hp = 100;
            me.score += 500;
        }

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            
            // Di chuyển bằng PC (WASD / Arrows)
            if(!me.isDead) {
                if(keys['KeyW'] || keys['ArrowUp']) me.y -= me.speed;
                if(keys['KeyS'] || keys['ArrowDown']) me.y += me.speed;
                if(keys['KeyA'] || keys['ArrowLeft']) me.x -= me.speed;
                if(keys['KeyD'] || keys['ArrowRight']) me.x += me.speed;
                
                // Di chuyển bằng Joystick (Mobile)
                me.x += joyX; me.y += joyY;

                // Giới hạn màn hình
                me.x = Math.max(0, Math.min(canvas.width - 40, me.x));
                me.y = Math.max(0, Math.min(canvas.height - 40, me.y));
            }

            // Host quản lý Zombie
            const isHost = !peer.id.includes('evolution');
            if(isHost && zombies.length < 8 && Math.random() < 0.03) {
                const side = Math.random() > 0.5;
                zombies.push({ 
                    id: Date.now(), 
                    x: side ? -50 : canvas.width + 50, 
                    y: Math.random() * canvas.height, 
                    hp: 60 + (me.lv * 10) 
                });
            }

            zombies.forEach(z => {
                let target = (me.isDead) ? enemy : me;
                let dx = target.x - z.x, dy = target.y - z.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                z.x += (dx/dist) * (1.2 + me.lv*0.2); 
                z.y += (dy/dist) * (1.2 + me.lv*0.2);

                if(dist < 30 && !me.isDead) {
                    me.hp -= 0.6;
                    if(me.hp <= 0) {
                        me.isDead = true;
                        setTimeout(() => { me.isDead = false; me.hp = 100; me.x = 300; me.y = 300; }, 3000);
                    }
                }
            });

            // Xử lý đạn
            me.bullets.forEach((b, bi) => {
                b.x += b.vx;
                zombies.forEach((z, zi) => {
                    let d = Math.sqrt((b.x - z.x)**2 + (b.y - z.y)**2);
                    if(d < 30) {
                        me.bullets.splice(bi, 1);
                        z.hp -= 20;
                        if(conn) conn.send({ type: 'hit-zombie', id: z.id });
                        if(z.hp <= 0) {
                            zombies.splice(zi, 1);
                            me.score += 100; me.kills++;
                            if(me.kills % 3 === 0) levelUp();
                        }
                    }
                });
                if(b.x > canvas.width || b.x < 0) me.bullets.splice(bi, 1);
            });

            if(conn && conn.open) {
                conn.send({
                    type: 'sync',
                    name: document.getElementById('name-in').value,
                    player: { x: canvas.width - me.x - 40, y: me.y, hp: me.hp, lv: me.lv, score: me.score, isDead: me.isDead },
                    zombies: zombies.map(z => ({ ...z, x: canvas.width - z.x })),
                    isHost: isHost
                });
            }

            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            
            // Vẽ Bạn (Màu xanh dương)
            if(!me.isDead) {
                ctx.fillStyle = "#3498db"; ctx.fillRect(me.x, me.y, 40, 40);
                ctx.fillStyle = "white"; ctx.font = "bold 12px Arial";
                ctx.fillText("BẠN", me.x + 5, me.y - 10);
            } else {
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.fillText("ĐANG HỒI SINH...", me.x - 20, me.y);
            }

            // Vẽ Đồng đội (Màu đỏ)
            if(!enemy.isDead) {
                ctx.fillStyle = "#e74c3c"; ctx.fillRect(enemy.x, enemy.y, 40, 40);
            }

            // Vẽ Zombie (Màu xanh lá)
            zombies.forEach(z => {
                ctx.fillStyle = "#2ecc71";
                ctx.beginPath(); ctx.arc(z.x + 20, z.y + 20, 18, 0, Math.PI*2); ctx.fill();
                // Máu zombie
                ctx.fillStyle = "#555"; ctx.fillRect(z.x, z.y - 10, 40, 4);
                ctx.fillStyle = "red"; ctx.fillRect(z.x, z.y - 10, (z.hp/(60+me.lv*10))*40, 4);
            });

            // Vẽ đạn
            ctx.fillStyle = "#f1c40f";
            me.bullets.concat(enemy.bullets || []).forEach(b => ctx.fillRect(b.x, b.y, 12, 4));

            document.getElementById('my-hp').style.width = me.hp + '%';
            document.getElementById('peer-hp').style.width = enemy.hp + '%';
            document.getElementById('my-lv').innerText = me.lv;
            document.getElementById('my-score').innerText = me.score.toLocaleString();
            document.getElementById('peer-lv').innerText = enemy.lv;
            document.getElementById('peer-score').innerText = enemy.score.toLocaleString();
        }

        // --- JOYSTICK MOBILE ---
        let joyX = 0, joyY = 0;
        const joy = document.getElementById('joystick');
        const st = document.getElementById('stick');
        joy.addEventListener('touchmove', e => {
            const t = e.touches[0]; const r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const d = Math.sqrt(dx*dx + dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            st.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx/8; joyY = dy/8;
        });
        joy.addEventListener('touchend', () => { joyX = 0; joyY = 0; st.style.transform = 'none'; });
        document.getElementById('btn-shoot').addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
    </script>
</body>
</html>
