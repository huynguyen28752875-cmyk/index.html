<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Street Fighters VN: Hybrid Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; }
        canvas { display: block; filter: saturate(1.3) contrast(1.1); }
        
        /* C·∫£nh b√°o xoay m√†n h√¨nh */
        #rotate-warning { position: absolute; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        @media (orientation: portrait) { #rotate-warning { display: flex; } }

        #lobby { position: absolute; inset: 0; background: radial-gradient(circle, #1e293b, #020617); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .char-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; }
        .char-card { border: 2px solid #334155; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; transition: 0.3s; width: 130px; text-align: center; cursor: pointer; }
        .char-card:hover { border-color: #fbbf24; transform: scale(1.05); box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
        .p1-sel { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.3); }
        .cpu-sel { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.3); }
        
        #game-ui { position: absolute; top: 20px; width: 100%; display: none; justify-content: space-between; padding: 0 50px; z-index: 10; pointer-events: none; }
        .bar-container { width: 350px; }
        .hp-outer { height: 25px; background: #1e293b; border: 2px solid #fff; border-radius: 5px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #b91c1c); width: 100%; transition: 0.2s; }
        .mana-outer { height: 10px; background: #0f172a; border: 1px solid #0ea5e9; margin-top: 5px; border-radius: 3px; }
        .mana-fill { height: 100%; background: #00d2ff; width: 0%; transition: 0.3s; }

        #mobile-controls { position: absolute; bottom: 20px; width: 100%; display: none; justify-content: space-between; padding: 0 40px; z-index: 50; }
        .btn-circle { width: 75px; height: 75px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; pointer-events: auto; -webkit-tap-highlight-color: transparent; }
        .btn-circle:active { background: rgba(255,255,255,0.4); transform: scale(0.9); }
    </style>
</head>
<body>

    <div id="rotate-warning">
        <div class="text-white text-2xl mb-4">üîÑ VUI L√íNG XOAY NGANG M√ÄN H√åNH</div>
        <div class="text-gray-400">ƒê·ªÉ c√≥ tr·∫£i nghi·ªám chi·∫øn ƒë·∫•u t·ªët nh·∫•t</div>
    </div>

    <div id="lobby">
        <h1 id="turn-txt" class="text-4xl font-black italic text-yellow-400 mb-8 tracking-tighter uppercase">Ch·ªçn Huy·ªÅn Tho·∫°i</h1>
        <div class="char-grid" id="grid"></div>
        <p id="mode-info" class="mt-6 text-blue-400 font-bold uppercase"></p>
    </div>

    <div id="game-ui">
        <div class="bar-container">
            <div class="hp-outer"><div id="p1-hp" class="hp-fill"></div></div>
            <div class="mana-outer"><div id="p1-mana" class="mana-fill"></div></div>
            <div class="font-bold text-blue-400 mt-1" id="p1-name">PLAYER 1</div>
        </div>
        <div class="bar-container text-right">
            <div class="hp-outer"><div id="p2-hp" class="hp-fill" style="float:right"></div></div>
            <div class="mana-outer"><div id="p2-mana" class="mana-fill" style="float:right"></div></div>
            <div class="font-bold text-red-500 mt-1" id="p2-name">CPU</div>
        </div>
    </div>

    <div id="mobile-controls">
        <div class="flex gap-4">
            <div class="btn-circle" onpointerdown="keys.KeyA=true" onpointerup="keys.KeyA=false">‚Üê</div>
            <div class="btn-circle" onpointerdown="keys.KeyW=true" onpointerup="keys.KeyW=false">‚Üë</div>
            <div class="btn-circle" onpointerdown="keys.KeyD=true" onpointerup="keys.KeyD=false">‚Üí</div>
        </div>
        <div class="flex gap-4">
            <div class="btn-circle bg-blue-600/20" onpointerdown="p1.attack('Punch')">P</div>
            <div class="btn-circle bg-red-600/20" onpointerdown="p1.attack('Kick')">K</div>
            <div class="btn-circle bg-yellow-600/40" onpointerdown="p1.attack('Ulti')">U</div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        function playSfx(f, t, d, v=0.1) {
            try {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
                g.gain.setValueAtTime(v, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination);
                o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d);
            } catch(e) {}
        }

        const chars = [
            { id: 'DanChoi', name: 'D√ÇN CH∆†I', color: '#3b82f6', s: 'M∆∞a L·ª≠a' },
            { id: 'HiepSi', name: 'HI·ªÜP Sƒ®', color: '#ef4444', s: 'M∆∞a T√™n' },
            { id: 'BO', name: 'C·ª§ BO', color: '#a855f7', s: 'ƒê·ªá T·ª≠' },
            { id: 'Bin', name: 'BIN', color: '#10b981', s: 'G·∫°ch ƒêao' },
            { id: 'Son', name: 'S∆†N', color: '#f97316', s: 'T·ªëc Bi·∫øn' }
        ];

        let p1Char, p2Char, p1, p2, isRunning = false, keys = {}, projectiles = [], minions = [], shake = 0, flash = 0;

        document.getElementById('mode-info').innerText = isMobile ? "Ch·∫ø ƒë·ªô: ƒê·∫•u v·ªõi M√°y (CPU)" : "Ch·∫ø ƒë·ªô: 2 Ng∆∞·ªùi ch∆°i (PVP)";

        const grid = document.getElementById('grid');
        chars.forEach(c => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.id = 'btn-' + c.id;
            card.innerHTML = `<div class="font-black text-white">${c.name}</div><div class="text-[9px] text-gray-400">${c.s}</div>`;
            card.onclick = () => pick(c.id);
            grid.appendChild(card);
        });

        function pick(id) {
            if(!p1Char) {
                p1Char = id; document.getElementById('btn-'+id).classList.add('p1-sel');
                playSfx(400, 'sine', 0.1);
                if(isMobile) {
                    // CPU t·ª± ch·ªçn ng·∫´u nhi√™n
                    const others = chars.filter(c => c.id !== id);
                    p2Char = others[Math.floor(Math.random()*others.length)].id;
                    document.getElementById('btn-'+p2Char).classList.add('cpu-sel');
                    setTimeout(startGame, 800);
                } else {
                    document.getElementById('turn-txt').innerText = "Ng∆∞·ªùi 2 Ch·ªçn";
                }
            } else if(!p2Char && !isMobile) {
                p2Char = id; document.getElementById('btn-'+id).classList.add('cpu-sel');
                playSfx(600, 'sine', 0.1); setTimeout(startGame, 800);
            }
        }

        function startGame() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            if(isMobile) document.getElementById('mobile-controls').style.display = 'flex';
            
            p1 = new Fighter(window.innerWidth*0.2, 1, p1Char);
            p2 = new Fighter(window.innerWidth*0.8, 2, p2Char);
            p2.isCPU = isMobile;
            document.getElementById('p2-name').innerText = isMobile ? "CPU: " + p2Char.toUpperCase() : "PLAYER 2";
            
            isRunning = true;
            // Nh·∫°c n·ªÅn
            setInterval(() => { if(isRunning) playSfx(55, 'sawtooth', 0.5, 0.02); }, 600);
        }

        class Fighter {
            constructor(x, id, type) {
                this.x = x; this.id = id; this.type = type;
                this.hp = 100; this.maxHp = 100; this.mana = 0;
                this.w = 80; this.h = 170; this.vy = 0; this.vx = 0;
                this.dir = id === 1 ? 1 : -1; this.isAtk = 0; this.stun = 0;
                this.isCPU = false;
                this.color = chars.find(c => c.id === type).color;
                this.spd = (type === 'DanChoi' || type === 'Son') ? 10 : 7;
            }
            draw() {
                ctx.save();
                if(shake > 0) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);
                
                // Shadow & Glow
                ctx.shadowBlur = 20; ctx.shadowColor = this.color;
                ctx.fillStyle = this.stun > 0 ? '#444' : this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                
                if(this.isAtk > 0) {
                    ctx.fillStyle = "rgba(255,255,255,0.6)";
                    ctx.fillRect(this.x + (this.dir > 0 ? this.w : -60), this.y + 50, 60, 40);
                    this.isAtk--;
                }
                ctx.restore();
            }
            update() {
                if(this.stun > 0) { this.stun -= 16; this.vx = 0; return; }
                
                if(this.isCPU) this.updateAI();

                this.x += this.vx; this.y += this.vy;
                if(this.y + this.h < canvas.height - 80) this.vy += 1.5;
                else { this.y = canvas.height - 80 - this.h; this.vy = 0; }
                this.mana = Math.min(100, this.mana + 0.1);
            }
            updateAI() {
                const dist = Math.abs(this.x - p1.x);
                // Di chuy·ªÉn √°p s√°t
                if(dist > 120) {
                    this.vx = this.x > p1.x ? -this.spd * 0.7 : this.spd * 0.7;
                    this.dir = this.x > p1.x ? -1 : 1;
                } else {
                    this.vx = 0;
                    // T·∫•n c√¥ng khi ƒë·ªß t·∫ßm
                    if(Math.random() < 0.05) this.attack(Math.random() > 0.5 ? 'Punch' : 'Kick');
                }
                // D√πng Ulti khi ƒë·ªß mana
                if(this.mana >= 100 && Math.random() < 0.02) this.attack('Ulti');
                // Ng·∫´u nhi√™n nh·∫£y
                if(Math.random() < 0.01 && this.vy === 0) this.vy = -20;
            }
            attack(t) {
                if(this.isAtk > 0 || this.stun > 0) return;
                if(t === 'Ulti' && this.mana < 100) return;
                
                if(t === 'Ulti') {
                    this.mana = 0; flash = 10; shake = 20; playSfx(40, 'sawtooth', 1, 0.2);
                    if(this.type === 'BO') {
                        for(let i=0; i<5; i++) minions.push({ x: this.x, y: this.y, hp: 50, owner: this.id, life: 600 });
                    } else if(this.type === 'Bin') {
                        projectiles.push({ x: this.x, y: this.y, vx: this.dir * 18, vy: -5, type: 'brick', owner: this.id });
                    } else if(this.type === 'DanChoi' || this.type === 'HiepSi') {
                        for(let i=0; i<10; i++) projectiles.push({ x: Math.random()*canvas.width, y: -100, vx: 0, vy: 12, type: this.type==='DanChoi'?'fire':'arrow', owner: this.id });
                    } else if(this.type === 'Son') {
                        let enemy = this.id === 1 ? p2 : p1;
                        this.x = enemy.x - (this.dir * 120); this.attack('Punch');
                    }
                    return;
                }
                
                this.isAtk = 15;
                let enemy = this.id === 1 ? p2 : p1;
                if(Math.abs(this.x - enemy.x) < 150 && Math.abs(this.y - enemy.y) < 180) {
                    enemy.hp -= t === 'Kick' ? 12 : 8;
                    this.mana = Math.min(100, this.mana + 15);
                    shake = 8; playSfx(100, 'square', 0.1);
                }
            }
        }

        window.onkeydown = e => { 
            keys[e.code] = true;
            if(!isRunning) return;
            if(e.code === 'KeyF') p1.attack('Punch'); if(e.code === 'KeyG') p1.attack('Kick'); if(e.code === 'KeyH') p1.attack('Ulti');
            if(!isMobile) {
                if(e.code === 'KeyK') p2.attack('Punch'); if(e.code === 'KeyL') p2.attack('Kick'); if(e.code === 'KeyJ') p2.attack('Ulti');
            }
        };
        window.onkeyup = e => keys[e.code] = false;

        function loop() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!isRunning) return requestAnimationFrame(loop);
            
            ctx.fillStyle = flash > 0 ? '#fff' : '#020617'; ctx.fillRect(0,0,canvas.width, canvas.height);
            if(flash > 0) flash--;

            // S√†n ƒë·∫•u & Kh√°n gi·∫£
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0, canvas.height-80, canvas.width, 80);
            ctx.fillStyle = '#1e293b'; 
            for(let i=0; i<15; i++) {
                let j = Math.sin(Date.now()*0.01 + i)*8;
                ctx.beginPath(); ctx.arc(i*(canvas.width/14), canvas.height-110+j, 20, 0, 7); ctx.fill();
            }

            [p1, p2].forEach(p => {
                if(p.stun <= 0) {
                    p.vx = 0;
                    if(p.id === 1) {
                        if(keys.KeyA) { p.vx = -p.spd; p.dir = -1; } if(keys.KeyD) { p.vx = p.spd; p.dir = 1; }
                        if(keys.KeyW && p.vy === 0) p.vy = -25;
                    } else if(!isMobile) {
                        if(keys.ArrowLeft) { p.vx = -p.spd; p.dir = -1; } if(keys.ArrowRight) { p.vx = p.spd; p.dir = 1; }
                        if(keys.ArrowUp && p.vy === 0) p.vy = -25;
                    }
                }
                p.update(); p.draw();
            });

            // Projectiles & Minions
            minions.forEach((m, i) => {
                m.life--; let e = m.owner === 1 ? p2 : p1;
                m.x += (e.x - m.x) * 0.04; m.y += (e.y - m.y) * 0.04;
                ctx.fillStyle = 'rgba(168, 85, 247, 0.6)'; ctx.fillRect(m.x, m.y, 40, 70);
                if(Math.abs(m.x - e.x) < 50) e.hp -= 0.1;
                if(m.life <= 0) minions.splice(i, 1);
            });

            projectiles.forEach((proj, i) => {
                proj.x += proj.vx; proj.y += proj.vy;
                ctx.fillStyle = proj.type==='fire'?'#f50':(proj.type==='brick'?'#844':'#0cf');
                ctx.fillRect(proj.x, proj.y, 25, 25);
                let e = proj.owner === 1 ? p2 : p1;
                if(proj.x < e.x+e.w && proj.x+25 > e.x && proj.y < e.y+e.h && proj.y+25 > e.y) {
                    e.hp -= 15; e.stun = proj.type==='brick'?4000:2000; projectiles.splice(i, 1);
                } else if(proj.y > canvas.height) projectiles.splice(i, 1);
            });

            if(shake > 0) shake *= 0.9;
            document.getElementById('p1-hp').style.width = p1.hp + '%';
            document.getElementById('p2-hp').style.width = p2.hp + '%';
            document.getElementById('p1-mana').style.width = p1.mana + '%';
            document.getElementById('p2-mana').style.width = p2.mana + '%';

            if(p1.hp <= 0 || p2.hp <= 0) {
                isRunning = false;
                alert(p1.hp <= 0 ? "CPU TH·∫ÆNG!" : "B·∫†N ƒê√É TH·∫ÆNG!");
                location.reload();
            }
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
